import { writeFile } from 'node:fs/promises';
import { BaseGenerator } from './base-generator';
import { resolveImportPath } from './boot-generator';
export function buildSchemaRegistry(ir) {
  const schemas = ir.schemas
    .filter((s) => s.isNamed)
    .map((s) => ({
      name: s.name,
      ...(s.id && { id: s.id }),
      importPath: s.sourceFile,
      variableName: s.name,
      ...(s.jsonSchema && { jsonSchema: s.jsonSchema }),
    }))
    .sort((a, b) => a.name.localeCompare(b.name));
  return { schemas };
}
function indentJson(value, indent) {
  return JSON.stringify(value, null, 2)
    .split('\n')
    .map((line, i) => (i === 0 ? line : `${indent}${line}`))
    .join('\n');
}
export function renderSchemaRegistryFile(manifest, outputDir) {
  const lines = ['// Auto-generated by @vertz/compiler â€” do not edit', ''];
  // Group imports by source file
  const importsByFile = new Map();
  for (const schema of manifest.schemas) {
    const resolvedPath = resolveImportPath(outputDir, schema.importPath);
    const existing = importsByFile.get(resolvedPath) ?? [];
    existing.push(schema.variableName);
    importsByFile.set(resolvedPath, existing);
  }
  for (const [path, names] of importsByFile) {
    lines.push(`import { ${names.join(', ')} } from '${path}';`);
  }
  if (manifest.schemas.length > 0) {
    lines.push('');
  }
  // Schema registry export
  lines.push('export const schemaRegistry = {');
  for (const schema of manifest.schemas) {
    lines.push(`  ${schema.variableName},`);
  }
  lines.push('} as const;');
  lines.push('');
  // JSON schemas export
  lines.push('export const jsonSchemas = {');
  for (const schema of manifest.schemas) {
    if (schema.jsonSchema) {
      lines.push(`  ${schema.name}: ${indentJson(schema.jsonSchema, '  ')},`);
    }
  }
  lines.push('} as const;');
  lines.push('');
  return lines.join('\n');
}
export class SchemaRegistryGenerator extends BaseGenerator {
  name = 'schema-registry';
  async generate(ir, outputDir) {
    const manifest = buildSchemaRegistry(ir);
    const content = renderSchemaRegistryFile(manifest, outputDir);
    const outputPath = this.resolveOutputPath(outputDir, 'schemas.ts');
    await writeFile(outputPath, content);
  }
}
//# sourceMappingURL=schema-registry-generator.js.map
