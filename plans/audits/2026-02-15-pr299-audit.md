# Post-Merge Audit: PR #299

**Title:** test: tree-shaking verification tests + fixes
**Author:** app/vertz-dev-front | **Merged:** 2026-02-15T03:01:22Z
**Stats:** +242 / -36 across 12 files

## Grade: A

## TDD Compliance

**Excellent.** This PR is itself a testing infrastructure PR — adding tree-shaking verification tests. The tests define the contract (single import ≤50% of full bundle), then the production fixes (`sideEffects: false`, `@__PURE__` annotation) make them pass. Classic red→green.

## Test Coverage

- `tree-shaking.test.ts` (127 lines) tests 7 packages against a 50% ratio threshold. ✅
- Uses real esbuild bundling — not mocked, verifies actual tree-shaking behavior. ✅
- Skips tiny packages (<2KB) to avoid false positives. Smart. ✅
- Dedicated vitest config and turbo task for isolation. ✅

## Code Quality

- Production fixes are minimal and correct:
  - `sideEffects: false` added to 6 package.json files (core, fetch, primitives, schema, server, ui)
  - `/* @__PURE__ */` annotation on `deepFreeze()` call in `vertz.ts`
- esbuild `0.27.3` added as root devDependency for the test infrastructure.
- `turbo.json` task added with `dependsOn: ["build"]` — correct since tests need dist output.
- `cache: false` on tree-shaking task — appropriate since results depend on bundle output.

## Security

- No security concerns. Test-only infrastructure + package.json metadata changes.

## Potential Regressions

- esbuild version bump from 0.25 to 0.27 at root level. Vite still pins 0.25 internally (visible in lockfile). No conflict since they're separate dependency trees.
- `sideEffects: false` is correct for these packages but any future side-effectful code (e.g., polyfills) would need explicit `sideEffects` array entries.

## Notable Findings

High-quality testing infrastructure. The esbuild-based approach catches real bundler behavior rather than relying on static analysis. The 50% threshold is reasonable — strict enough to catch barrel-file issues, lenient enough for small packages.
