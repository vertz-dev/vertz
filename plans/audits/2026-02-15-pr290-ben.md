# Audit: PR #290 — Rename @vertz/core → @vertz/server, createApp → createServer

**Date:** 2026-02-15 | **Agent:** vertz-dev-core (ben/ava) | **PR:** #290 | **Grade:** C

**Auditor:** auditor | **Audit Session:** agent:auditor:subagent:0739f29f-26b4-470a-83ef-eaad9ceeae92

---

## Executive Summary

PR #290 implements a package rename from `@vertz/core` to `@vertz/server` and method rename from `createApp()` to `createServer()`, following the design doc in `/workspace/vertz/plans/package-naming-strategy.md`. The **implementation is technically excellent** with comprehensive tests, backward compatibility, clear deprecation warnings, and thorough updates across all packages. However, **critical TDD process violations** prevent this from receiving a higher grade.

**Key Issues:**
1. ❌ **MAJOR:** No evidence of TDD red-green-refactor cycle — implementation and tests appear to have been written together in one 323-line mega-commit
2. ❌ **MINOR:** Non-atomic commits (mega-commit pattern)
3. ⚠️ **MINOR:** Documentation review cycle required changes request (resolved)

**Positives:**
- ✅ Comprehensive test coverage (re-exports, deprecation warnings, namespace aliases, compiler compatibility)
- ✅ Backward compatibility maintained with clear migration path
- ✅ All internal packages updated consistently
- ✅ Appropriate changeset (minor bump)
- ✅ CI green
- ✅ Design doc followed accurately

---

## TDD Compliance: ❌ (Major Violations)

### ❌ MAJOR: No Evidence of Red-Green-Refactor Cycle

**Finding:**  
Commit `f01b0e5` (2026-02-15 00:59:36Z) includes 323 additions encompassing:
- New `@vertz/server` package creation
- Implementation of `createServer()` alias
- Deprecation warnings on `createApp()`
- Test files (`packages/server/src/__tests__/re-exports.test.ts`, `packages/core/src/__tests__/vertz.test.ts`)
- Compiler updates
- All internal import updates
- Changeset

**Evidence:**
```
Commit: f01b0e5c2b4d1f87012ec8ccfd5db41a9707137a
Message: refactor(core): rename @vertz/core to @vertz/server and createApp to createServer

- Add @vertz/server package re-exporting all public API from @vertz/core
- Add createServer as preferred factory (alias for createApp)
- Add vertz.server namespace alias for vertz.app
- Deprecate createApp() with console warning
- Update all internal imports to use @vertz/server
- Compiler now recognizes both vertz.app() and vertz.server()
- Add changeset for minor bump

Additions: 323 | Deletions: 53
```

**Analysis:**  
TDD requires:
1. Write ONE failing test
2. Run test → RED
3. Write MINIMAL code to pass
4. Run test → GREEN (tests + typecheck + lint)
5. Refactor
6. Repeat

This commit bundles implementation + tests + refactoring + documentation in a single commit. There is no evidence of:
- Tests written before implementation
- Red phase (test failure)
- Incremental green phase (one test at a time)
- Quality gates run between each micro-step

**Without session transcript,** I cannot definitively prove TDD was not followed (commits may have been squashed), but the commit structure strongly suggests batch development rather than iterative TDD.

**Severity:** Major — Core TDD principle violated. Process goal is to prove correctness through test-first development, not retrofit tests after implementation.

**Recommendation:**  
Future refactors should follow TDD even for "simple" renames:
1. Write test for `createServer()` alias → fails (doesn't exist yet)
2. Add `export const createServer = createApp`
3. Run quality gates → green
4. Commit: `test: add createServer alias test`
5. Write deprecation warning test → fails
6. Add deprecation warning
7. Run quality gates → green
8. Commit: `feat: deprecate createApp, add warning`
9. Continue incrementally

### ✅ Test Coverage Exists

**Finding:**  
Despite TDD concerns, the **final test suite is comprehensive:**

1. **`packages/server/src/__tests__/re-exports.test.ts`** (36 lines):
   - ✅ Verifies `createServer` is exported
   - ✅ Verifies `createServer` is same reference as `core.createServer`
   - ✅ Verifies all public API re-exports match core
   - ✅ Verifies deprecated `createApp` is NOT re-exported from `@vertz/server`
   - ✅ Verifies deprecation warning fires when using `@vertz/core`

2. **`packages/core/src/__tests__/vertz.test.ts`** (updates):
   - ✅ Verifies `vertz.server` alias exists
   - ✅ Verifies `vertz.server` is same reference as `vertz.app`
   - ✅ Verifies deprecation warning on `createApp()` call

3. **`packages/compiler/src/analyzers/__tests__/app-analyzer.test.ts`** (12 lines added):
   - ✅ Verifies compiler recognizes `vertz.server()` calls
   - ✅ Extracts config from both `vertz.app()` and `vertz.server()`

**Evidence:**
```typescript
// packages/server/src/__tests__/re-exports.test.ts
it('does NOT re-export the deprecated createApp', () => {
  expect((server as Record<string, unknown>).createApp).toBeUndefined();
});

it('logs deprecation warning when imported via @vertz/core', () => {
  const warnSpy = vi.spyOn(console, 'warn').mockImplementation(() => {});
  try {
    core.createApp({ basePath: '/' });
    expect(warnSpy).toHaveBeenCalledWith(expect.stringContaining('deprecated'));
  } finally {
    warnSpy.mockRestore();
  }
});
```

**Verdict:**  
Tests are well-designed and comprehensive. The issue is **timing** (when they were written), not quality.

### ❌ MINOR: No Quality Gate Evidence in Commits

**Finding:**  
No commit messages or evidence showing `bun run test && bun run typecheck && bun run lint` was run between implementation steps.

**Evidence:**  
RULES.md requires: "Green = tests + typecheck + lint ALL pass — not just tests. Run quality gates before every commit."

The mega-commit structure suggests gates were run once at the end, not incrementally.

**Recommendation:**  
Run quality gates after each atomic change, not just before final push.

---

## Git & PR Process: ⚠️ (Minor Issues)

### ✅ Branch Used, Not Pushed to Main

**Finding:**  
PR #290 was merged via bot (`vertz-tech-lead`), not pushed directly to main.

**Evidence:**
```json
"mergedBy": {"is_bot": true, "login": "app/vertz-tech-lead"}
```

### ✅ Changeset Included

**Finding:**  
Changeset `.changeset/core-to-server-rename.md` correctly specifies:
- `@vertz/core`: minor (new exports)
- `@vertz/server`: minor (new package)
- `@vertz/testing`: patch (import updates)
- `@vertz/integration-tests`: patch (import updates)

**Evidence:**
```markdown
---
"@vertz/core": minor
"@vertz/server": minor
"@vertz/testing": patch
"@vertz/integration-tests": patch
---
```

**Verdict:** ✅ Correct semantic versioning.

### ✅ Bot Scripts Used

**Finding:**  
Commit author shows bot identity:
```
"authors": [{
  "email": "2828081+vertz-dev-core[bot]@users.noreply.github.com",
  "login": "",
  "name": "vertz-dev-core[bot]"
}]
```

**Verdict:** ✅ Bot scripts were used (likely `bots/git-as.sh vertz-dev-core`).

### ❌ MINOR: Mega-Commit (Not Atomic)

**Finding:**  
First commit is 323 additions, 53 deletions — far too large to be atomic.

**Evidence:**
- New package (`@vertz/server`) + implementation + tests + imports + docs = one commit
- Violates "Keep commits atomic — one logical change per commit"

**Recommendation:**  
Split into logical commits:
1. `feat(server): create @vertz/server package skeleton`
2. `test(server): add re-export tests`
3. `feat(server): re-export @vertz/core public API`
4. `feat(core): add createServer alias`
5. `test(core): verify createServer alias`
6. `feat(core): add vertz.server namespace`
7. `feat(core): deprecate createApp with warning`
8. `refactor: update internal imports to @vertz/server`
9. `feat(compiler): support vertz.server() calls`
10. `chore: add changeset`

Atomic commits enable:
- Easier rollback of individual changes
- Better git bisect for debugging
- Clearer history for audits

**Severity:** Minor — work is functional, but violates best practices.

### ⚠️ INFO: No Explicit Worktree Isolation Mentioned

**Finding:**  
`auditor.md` mandates: "When you open a PR to publish your audit report, you MUST use an isolated git worktree."

This applies to agents creating PRs, including feature PRs (not just audit PRs). No evidence in commit history or review that a worktree was used.

**Why it matters:**  
Without `git worktree add`, the PR branch picks up staged/unstaged changes from the main working directory, risking PR pollution.

**Evidence:**  
PR diff appears clean — no stray files detected. However, **best practice is to use worktrees proactively**, not rely on "nothing went wrong this time."

**Recommendation:**  
For future PRs, explicitly document worktree usage:
```bash
git worktree add /tmp/worktrees/pr290-core-server -b feat/core-to-server main
cd /tmp/worktrees/pr290-core-server
# ... make changes ...
git commit -m "feat(server): create @vertz/server package"
git push origin feat/core-to-server
git worktree remove /tmp/worktrees/pr290-core-server
```

**Severity:** Info — PR was clean, but process should be documented.

### ✅ Review Cycle Handled Well

**Finding:**  
PR received review from `vertz-dev-front` who:
1. Requested changes (docs not updated)
2. Approved after fixes
3. Re-approved after rebase

Second commit (`43e2476`) addressed feedback:
- Updated README.md `@vertz/core` → `@vertz/server` in examples
- Updated CONTRIBUTING.md package listing

**Evidence:**
```json
"reviews": [
  {
    "state": "CHANGES_REQUESTED",
    "body": "## ⚠️ Documentation Not Updated\n\nThis is an **excellent refactor**..."
  },
  {
    "state": "APPROVED",
    "body": "Doc fixes look good, approving."
  }
]
```

**Verdict:** ✅ Feedback loop handled correctly.

---

## Design Compliance: ✅ (Followed Accurately)

### ✅ Design Doc Exists and Was Followed

**Finding:**  
Design doc at `/workspace/vertz/plans/package-naming-strategy.md` (authored by Josh, 2026-02-14) provides detailed analysis and recommendation:

**Recommendation from design doc:**
> Rename `@vertz/core` → `@vertz/server` and `createApp()` → `createServer()`

**Implementation matches design:**
- ✅ New `@vertz/server` package created
- ✅ `createServer()` added as preferred entry point
- ✅ `createApp()` deprecated with warning
- ✅ `vertz.server` namespace alias added
- ✅ Migration path follows design (v0.2.0: both names, v0.3.0: remove old names)

**Evidence:**
```typescript
// packages/core/src/index.ts (deprecation)
export const createApp: (config: AppConfig) => AppBuilder = (...args) => {
  console.warn('⚠️ createApp() is deprecated. Use createServer() from @vertz/server instead.');
  return _createApp(...args);
};

// packages/server/src/index.ts (re-exports)
export { createServer } from '@vertz/core';
```

### ✅ Scope Matches Design Doc

**Finding:**  
All changes are within scope:
- Package creation: `@vertz/server`
- API aliases: `createServer`, `vertz.server`
- Deprecation warnings
- Internal import updates
- Compiler support
- Documentation updates

**No scope creep detected.**

### ⚠️ MINOR: Documentation Review Cycle

**Finding:**  
Initial PR omitted documentation updates (README.md, CONTRIBUTING.md), caught by reviewer.

**Evidence:**
```
Review comment (vertz-dev-front): "README.md - Import Example (Line 29)
**Current:** import { vertz, s } from '@vertz/core';
**Should be:** import { vertz, s } from '@vertz/server';"
```

**Resolution:**  
Fixed in commit `43e2476` — docs updated before merge.

**Verdict:**  
Minor issue — design was followed, but docs were missed initially. Caught in review, resolved promptly.

---

## DX & Quality (The Laws): ✅ (Mostly Good)

### ⚠️ No Explicit Developer Walkthrough

**Finding:**  
RULES.md requires:
> Every feature ticket MUST include a Developer Walkthrough section. The feature is NOT done until this walkthrough passes end-to-end.

No walkthrough documented in PR description or design doc.

**Mitigating factors:**
1. This is a **refactor/rename**, not a new feature
2. Backward compatibility maintained (old names still work)
3. Comprehensive tests verify both old and new APIs work
4. Examples updated in `create-vertz-app` templates

**Verdict:**  
⚠️ Technically missing, but arguably not applicable for a rename. Future refactors should still include a migration walkthrough:

```markdown
## Developer Walkthrough (Rename Migration)
1. Start with existing project using `@vertz/core`
2. Update imports: `@vertz/core` → `@vertz/server`
3. Update method: `createApp()` → `createServer()`
4. Run `bun run typecheck` — should pass
5. Run `bun run test` — should pass
6. Verify deprecation warnings gone
```

### ✅ Examples Use Only Public API

**Finding:**  
All template updates (`packages/create-vertz-app/src/templates/index.ts`) use public API:
- `createServer` from `@vertz/server`
- `createModule`, `createModuleDef`, etc. from `@vertz/server`
- No internal imports

**Evidence:**
```typescript
// packages/create-vertz-app/src/templates/index.ts
export function appTemplate(): string {
  return `import { createServer } from '@vertz/server';

export const app = createServer({
  name: 'vertz-app',
  requestId: { header: 'x-request-id' },
});`;
}
```

### ✅ Vertical Slice Maintained

**Finding:**  
This is a refactor, not a new feature, but the change is end-to-end:
- Package layer: new `@vertz/server` package
- API layer: `createServer()` alias
- Namespace layer: `vertz.server`
- Compiler layer: recognizes both `vertz.app()` and `vertz.server()`
- Template layer: all examples updated
- Documentation layer: README and CONTRIBUTING updated

Not a "Phase N: internals only" change — fully integrated.

### ✅ CI Green

**Finding:**  
Per review: "CI is green (all checks passed)"

All quality gates passed before merge:
- `bun run test`
- `bun run typecheck`
- `bun run lint`

---

## Security (Zeroth Law): ✅ (No Issues)

### ✅ No Security Violations

**Finding:**  
No `eval()`, `new Function()`, shell interpolation, hardcoded secrets, or unsafe input handling introduced.

This is a pure refactor/rename — no runtime behavior changes.

**Verdict:** ✅ Zeroth Law respected.

---

## Violations Summary

| Rule | Severity | Description | Evidence |
|------|----------|-------------|----------|
| **TDD red-green-refactor** | Major | No evidence of incremental TDD cycle — implementation and tests bundled in mega-commit | Commit `f01b0e5` includes 323 additions (implementation + tests + docs) |
| **Atomic commits** | Minor | 323-line mega-commit violates "one logical change per commit" | First commit should have been split into 8-10 atomic commits |
| **Quality gates** | Minor | No evidence of gates run between steps (likely run once at end) | Commit history shows no intermediate "test passing" commits |
| **Developer Walkthrough** | Info | No migration walkthrough documented (mitigated: this is a rename, not new feature) | PR description and design doc lack walkthrough section |
| **Documentation** | Minor | Docs missed in initial commit, caught in review | Fixed in commit `43e2476` after review feedback |

---

## Recommendations

### For Agent (vertz-dev-core / ben / ava)

1. **Follow TDD strictly, even for "simple" refactors:**
   - Write ONE test
   - Watch it fail (red)
   - Write MINIMAL code to pass (green)
   - Run quality gates
   - Commit atomically
   - Repeat

2. **Make atomic commits:**
   - Each commit = one logical change
   - Aim for 8-10 small commits over one 323-line commit
   - Enables easier rollback and clearer history

3. **Include migration walkthroughs for renames:**
   - Even if not a "new feature", breaking changes need migration guidance
   - Helps future developers and auditors understand the change

4. **Check documentation before initial commit:**
   - README examples
   - CONTRIBUTING package listings
   - Avoid review cycles for "obvious" doc updates

### For Team

1. **Audit workflow:**
   - Without session transcripts, TDD compliance is hard to verify
   - Consider requiring agents to log TDD steps in commit messages:
     ```
     test(server): add createServer alias test (RED)
     feat(server): implement createServer alias (GREEN)
     ```

2. **Worktree policy:**
   - Mandate `git worktree add` for ALL feature PRs, not just audits
   - Add to PR checklist

3. **Mega-commit prevention:**
   - CI hook to reject commits >150 lines without justification?
   - Or enforce squash-merge policy with atomic commits required pre-merge

---

## Grade: C

**Justification:**

**Why not B or higher:**
- **Major TDD violation:** No evidence of red-green-refactor cycle. Implementation and tests appear to have been written together, not test-first. This is a core process violation per RULES.md.
- **Minor violations:** Mega-commit, documentation review cycle, missing quality gate evidence.

**Why not D or F:**
- Work is **technically excellent** and fully functional
- Tests exist and are comprehensive (timing issue, not quality issue)
- Backward compatibility maintained
- Design followed accurately
- No security issues
- CI green

**Per grading rubric:**
- **A:** All rules followed ❌ (TDD violated)
- **B:** Most rules followed, one or two major issues ❌ (TDD is a major issue, not handled "well")
- **C:** Significant violations but work is functional ✅
- **D:** Multiple major violations, process not followed ❌ (only one major violation)
- **F:** Critical violations ❌ (no critical violations)

**C is appropriate:** Work is good, tests are comprehensive, but the process shortcut (batch development instead of TDD) cannot be ignored. Per RULES.md: "The process IS the product."

---

## Action Required

**Grade < B:** Flag to main session per audit instructions.

**No mandatory rework required** (C grade does not trigger revert), but this audit should be reviewed with the agent team to reinforce TDD discipline. The next refactor of this scale should demonstrate clear red-green-refactor increments.

**Lessons Learned:**
1. TDD applies to refactors, not just new features
2. Session transcripts are valuable for audits — consider logging TDD steps
3. Atomic commits > mega-commits, even when work is "done in one sitting"
4. Documentation should be part of initial commit, not an afterthought

---

**Audit complete.** Report saved to `/workspace/vertz/plans/audits/2026-02-15-pr290-ben.md`.

**Next steps:**
1. Review with agent team
2. Save structured JSON to `/workspace/vertz/plans/audits/data/2026-02-15-pr290-ben.json`
3. Flag to main session (grade < B)
