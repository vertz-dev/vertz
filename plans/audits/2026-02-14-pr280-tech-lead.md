# Audit: PR #280 ‚Äî revert: signal auto-unwrap (PR #269) ‚Äî Grade D audit, mandatory TDD redo

**Date:** 2026-02-14 | **Agent:** vertz-tech-lead (nora/mike) | **PR:** #280 | **Grade:** D

**Merged:** 2026-02-14T17:49:42Z | **Merged By:** vertz-tech-lead[bot] | **Files Changed:** 14 (+930, -690)

---

## üö® MANDATORY REWORK REQUIRED

**Grade D:** This PR must be reverted and redone from scratch following strict TDD. No code reuse.

Per RULES.md audit enforcement policy (which this PR itself added):
> **D: Mandatory rework.** Revert the PR and redo the work from scratch following strict TDD. Do NOT reuse the original code ‚Äî write it fresh, test-first.

**Irony Alert:** This PR adds the audit enforcement policy to RULES.md while simultaneously violating it.

---

## Executive Summary

PR #280 ostensibly reverts PR #269 (Grade D) per new audit enforcement policy. However, the PR **bundles four unrelated concerns**:

1. ‚úÖ **Shell injection security fix** (CWE-78) ‚Äî Critical security fix, properly tested
2. ‚úÖ **Revert of PR #269** ‚Äî Required per Grade D policy
3. ‚úÖ **Audit enforcement policy** ‚Äî Meta documentation update
4. ‚ùå **Audit of PR #277** ‚Äî Completely unrelated scope violation

**Critical Issues:**

- **‚ùå SCOPE VIOLATION:** Mixes revert + security fix + policy update + unrelated audit (4 concerns)
- **‚ùå TDD BYPASSED:** Security fix (222 lines) committed in one mega-commit, then 6th commit fixes failing tests
- **‚ùå NO TICKET:** No ticket for revert work or security fix
- **‚ùå QUALITY GATES FAILED:** 6th commit fixes test failures, proving tests were pushed while failing
- **‚ùå WORKTREE POLLUTION:** Audit for PR #277 committed from main branch, not isolated worktree

**Strengths:**

- ‚úÖ Security fix is critical and correct (prevents command injection)
- ‚úÖ Comprehensive security tests (149 lines, 11 test cases)
- ‚úÖ Revert properly undoes all PR #269 changes
- ‚úÖ Changeset added for security fix

---

## TDD Compliance: ‚ùå (Grade: F)

### CRITICAL: Implementation + Tests Committed Together

**Evidence:** Commit `4bf9b75` (17:28:44Z): "fix(demo-toolkit): replace shell interpolation with spawn()"
- **222 lines changed** (+212, -10) in a single commit
- Both implementation AND tests committed together
- No evidence of red-green-refactor cycle

**Files committed together:**
```
packages/demo-toolkit/src/muxing.ts          (+80 lines implementation)
packages/demo-toolkit/tests/muxing.test.ts   (+132 lines tests)
```

**RULES.md violation:**
> "Red ‚Üí Green ‚Üí Refactor. One test at a time. Write ONE failing test, write MINIMAL code to pass it, run quality gates (tests + typecheck + lint ALL pass), refactor while staying green, repeat."

**What should have happened:**

```bash
# Cycle 1: First security test
git add packages/demo-toolkit/tests/muxing.test.ts  # Only the test!
bun run test  # RED - validatePath doesn't exist
git add packages/demo-toolkit/src/muxing.ts  # Add validatePath function
bun run test && bun run typecheck && bun run lint  # GREEN
git commit -m "test: reject shell metacharacters in paths (CWE-78)"

# Cycle 2: Second test case
git add packages/demo-toolkit/tests/muxing.test.ts  # Add next test
bun run test  # RED - combineVideoAudio doesn't validate
# ... implement validation check
bun run test && bun run typecheck && bun run lint  # GREEN
git commit -m "feat: validate paths in combineVideoAudio"

# Repeat for each function (combineVideoAudio, createAudioTimeline)
```

**Actual history:**
```
4bf9b75 17:28:44 - fix(demo-toolkit): replace shell interpolation... [+222 lines]
```

**Severity:** CRITICAL ‚Äî This is the same TDD violation that caused PR #269 to receive Grade D. The agent repeated the exact mistake it was supposed to be correcting.

---

### CRITICAL: Quality Gates Failed, Then Fixed in Follow-Up Commit

**Evidence:** Commit `ed0c8ff` (17:41:44Z ‚Äî 13 minutes after initial commit):
```
fix(demo-toolkit): validate AudioClip paths before FFmpeg check

The security validation for AudioClip paths must run before the
hasFFmpeg check to ensure shell injection protection (CWE-78) is
enforced even when FFmpeg is not available (e.g., in CI environment).

This fixes the failing test: 'should reject malicious AudioClip path
in createAudioTimeline'
```

**Analysis:**
1. Initial implementation (commit 1) had **failing tests**
2. Tests were committed and pushed while failing
3. 13 minutes later, implementation fixed to make tests pass

**RULES.md violation:**
> "Pre-push: bun run test && bun run typecheck && bun run lint. All three must pass. A push with failing gates is a process violation."

**What the commit message reveals:**
- Test `'should reject malicious AudioClip path in createAudioTimeline'` was FAILING
- The bug: `validatePath()` was called AFTER the `if (!hasFFmpeg)` early return
- This means the test framework detected a real security vulnerability (validation could be bypassed)
- Agent pushed code that failed its own security tests

**Severity:** CRITICAL ‚Äî Pushing code with failing tests is a cardinal sin. Even worse when the failing test detects a security vulnerability.

---

### Evidence: No Incremental Commits

**Expected commit history for TDD:**
```
1. test: should reject malicious videoPath (RED)
2. feat: add validatePath helper function (GREEN)
3. test: should reject malicious audioPath (RED)
4. feat: validate audioPath in combineVideoAudio (GREEN)
5. test: should reject malicious outputPath (RED)
6. feat: validate outputPath in combineVideoAudio (GREEN)
7. refactor: replace execAsync with execFileAsync (GREEN, refactor)
8. test: should reject malicious AudioClip path (RED)
9. feat: validate clips in createAudioTimeline (GREEN)
10. test: should accept paths with spaces (RED)
11. feat: ensure validation doesn't break valid paths (GREEN)
```

**Actual commit history:**
```
1. fix(demo-toolkit): all implementation + all tests [222 lines]
2. docs: add audit policy
3. revert: PR #269
4. chore: add changeset
5. audit: PR #277
6. fix: make failing test pass
```

**Verdict:** Zero evidence of TDD. Tests were written alongside (or possibly after) implementation.

---

## Process: ‚ùå (Grade: D)

### CRITICAL: Scope Violation ‚Äî Four Unrelated Concerns in One PR

**Issue:** PR mixes:
1. **Shell injection security fix** (muxing.ts + tests)
2. **Revert of PR #269** (8 files deleted)
3. **Audit enforcement policy** (RULES.md update)
4. **Audit of PR #277** (2 files: markdown + JSON)

**Evidence from PR body:**
> **Title:** "revert: signal auto-unwrap (PR #269) ‚Äî Grade D audit, mandatory TDD redo"
>
> Yet the PR includes a major security fix (222 lines) and an audit for a completely different PR (#277).

**RULES.md violation:**
> "One feature per PR. Scope creep is the #1 agent failure mode."
> "Never bundle unrelated work ‚Äî even if files are 'on disk and ready', create separate PRs for separate concerns."

**What should have happened:**
```bash
# PR #280: Security fix (URGENT - Zeroth Law)
fix(demo-toolkit): prevent shell injection in muxing commands (CWE-78)
- Replace execAsync with execFileAsync
- Add validatePath() security checks
- Add 149 lines of security tests

# PR #281: Revert PR #269 per Grade D audit
revert: signal auto-unwrap (PR #269) ‚Äî Grade D audit, mandatory TDD redo
- Revert commit 94fd13d
- Remove changeset
- Remove 8 feature files

# PR #282: Add audit enforcement policy
docs(rules): add audit grade enforcement (D/F = mandatory rework)
- Update RULES.md with D/F consequences
- Document "no code reuse" rationale

# PR #283: Publish audit for PR #277
chore(audit): publish audit for PR #277 (Grade C)
- Use isolated git worktree
- Add audit markdown + JSON
```

**Why bundling is harmful:**
1. **Review burden:** Reviewer must evaluate security fix + revert + policy + audit simultaneously
2. **Git history pollution:** Searching for "revert 269" finds unrelated security fixes
3. **Rollback complexity:** Cannot revert just the audit or just the security fix
4. **Audit worktree contamination:** The PR #277 audit files prove the agent didn't use an isolated worktree

**Severity:** CRITICAL ‚Äî This PR bundles FOUR separate concerns, including a security fix that should have been a standalone urgent PR (Zeroth Law priority).

---

### MAJOR: No Ticket for Security Fix or Revert

**Issue:** No ticket exists for either the shell injection fix OR the revert work.

**Evidence:**
- Searched `/workspace/vertz/tickets/` ‚Äî no ticket for "shell injection", "CWE-78", "muxing spawn", "revert 269", or "signal unwrap redo"
- PR body doesn't reference a ticket
- Commits don't include ticket IDs

**RULES.md violation:**
> "Never commit without a ticket"

**Analysis:**
- **Security fix:** Could be considered Tier 1 bug (critical), but still requires a ticket per `bug-process.md`
- **Revert:** Triggered by audit, but should have a ticket documenting the redo plan

**What should exist:**
```markdown
# tickets/security/sec-001-shell-injection-muxing.md
**Severity:** CRITICAL (Zeroth Law - security)
**CWE:** CWE-78 (OS Command Injection)

Context: muxing.ts uses execAsync with template literals, enabling shell
injection if attacker controls file paths.

POC: User provides path `"; rm -rf /; echo "` ‚Üí executes arbitrary commands

Fix: Replace execAsync with execFileAsync (spawn with arg array)
Acceptance: All security tests pass, no shell metacharacters executed

---

# tickets/rework/rework-001-signal-unwrap-tdd-redo.md
**Context:** PR #269 received Grade D for TDD violations
**Requirement:** Revert + redo from scratch with strict TDD

Original scope: Auto-unwrap signal properties (query(), form(), createLoader())
Redo plan:
1. Create isolated worktree
2. Write failing test: query().loading ‚Üí query().loading.value
3. Implement minimal signal-api-registry.ts
4. Write failing test: form().submitting ‚Üí form().submitting.value
5. Extend registry
6. ... (continue TDD cycle)

Acceptance: Same functionality, strict TDD process with incremental commits
```

**Severity:** MAJOR ‚Äî Both the security fix and the revert are significant work requiring tickets for traceability.

---

### MAJOR: Audit Files Committed from Main Branch (Worktree Pollution)

**Issue:** Audit files for PR #277 were added from the main working directory, not an isolated worktree.

**Evidence:** Commit `ab9863e` (17:33:36Z) in PR #280's branch:
```
audit: PR #277 (vertz-tech-lead) - Grade C

plans/audits/2026-02-14-pr277-agent.md
plans/audits/data/2026-02-14-pr277-agent.json
```

**auditor.md requirement:**
> "‚ö†Ô∏è Creating Audit PRs ‚Äî Worktree Isolation (MANDATORY)
> When you open a PR to publish your audit report, you MUST use an isolated git worktree. This prevents your audit branch from picking up uncommitted changes from other features."

**Why this happened:** The agent (auditor) wrote audit files to disk in the main workspace, then another agent (vertz-tech-lead) picked them up in the revert branch.

**Irony:** PR #280 is reverting PR #269, which itself got dinged for worktree pollution (picking up audit files from other work). This PR **repeats the exact same mistake**.

**Correct workflow:**
```bash
# When auditor finishes PR #277 audit:
git worktree add /tmp/worktrees/audit-pr277 -b audit/pr277 main
cd /tmp/worktrees/audit-pr277
cp /workspace/vertz/plans/audits/2026-02-14-pr277-agent.md plans/audits/
cp /workspace/vertz/plans/audits/data/2026-02-14-pr277-agent.json plans/audits/data/
git add plans/audits/
git commit -m "audit: PR #277 (vertz-tech-lead) - Grade C"
git push origin audit/pr277
gh pr create --title "audit: PR #277" --body "..."
git worktree remove /tmp/worktrees/audit-pr277
```

**Severity:** MAJOR ‚Äî Repeating the same worktree violation the PR is supposed to be fixing.

---

### MINOR: Changesets Not Atomic

**Issue:** Changeset added in commit 4 (17:32:30Z), not with the implementation in commit 1 (17:28:44Z).

**Expected workflow:**
- Implementation commit includes changeset
- One atomic change: code + changeset + tests

**Actual workflow:**
- Commit 1: Implementation + tests
- Commit 4 (4 minutes later): Changeset

**Severity:** MINOR ‚Äî Changeset exists and is correct, just added non-atomically.

---

### ‚úÖ Bot Identity Used Correctly

**Evidence:** Commit author: `auditor@vertz.dev` for commits 1-5, merged by `vertz-tech-lead[bot]`

**Note:** The author email `auditor@vertz.dev` doesn't match the bot that opened the PR (`vertz-tech-lead`). This suggests the work was done by `auditor` agent, then PR created by `vertz-tech-lead`. Acceptable if coordinated, but adds confusion.

---

### ‚úÖ Revert Executed Correctly (Technical Execution)

**Evidence from diff:**
```diff
- signal-api-registry.ts (54 lines deleted)
- reactivity-analyzer.ts changes (107 lines deleted)
- signal-transformer.ts changes (89 lines deleted)
- signal-unwrap-demo.test.ts (130 lines deleted)
- types.ts signal-object changes (4 lines deleted)
- .changeset/signal-auto-unwrap.md (deleted)
```

Commit message: `Revert "feat(compiler): eliminate .value from public API ‚Äî auto-unwrap signal properties (#269)"`

**Analysis:** The revert cleanly undoes all PR #269 changes. No leftover code or half-reverts.

---

### ‚úÖ Conventional Commits Used

**Evidence:**
```
fix(demo-toolkit): replace shell interpolation with spawn()
docs: add audit grade enforcement policy
Revert "feat(compiler): eliminate .value from public API..."
chore: add changeset for shell injection fix
audit: PR #277 (vertz-tech-lead) - Grade C
fix(demo-toolkit): validate AudioClip paths before FFmpeg check
```

All commits follow conventional commit format.

---

## Design Compliance: ‚ùå (Grade: F)

### CRITICAL: No Ticket

Already covered under **Process** above. Absolute rule violation.

---

### ‚ö†Ô∏è No Design Doc for Revert Strategy

**Issue:** The PR implements a complex multi-step operation (security fix + revert + policy + audit) with no design doc outlining the strategy.

**What should exist:**
```markdown
plans/rework-pr269-revert-strategy.md

Scope:
1. Revert PR #269 changes (8 files)
2. Add audit enforcement policy to RULES.md
3. Schedule redo ticket with TDD requirements

Out of scope:
- Unrelated security fixes (separate PR)
- Unrelated audits (separate PR)

Acceptance:
- PR #269 fully reverted
- No new functionality added
- Redo ticket exists with TDD checklist
```

**Severity:** MINOR ‚Äî Reverts are typically straightforward, but bundling multiple concerns warranted a design doc.

---

### ‚úÖ Read RULES.md (Evidence Suggests)

**Evidence:**
- PR correctly adds audit enforcement policy to RULES.md
- Security fix uses spawn() pattern per RULES.md security guidelines
- Revert references Grade D audit (showing awareness of audit system)

---

### ‚ùå Scope Compliance

Already covered under **Process** above. Four separate concerns bundled.

---

## DX & Quality: ‚ö†Ô∏è (Grade: C)

### ‚úÖ Security Fix is Critical and Correct

**CWE-78 Prevention:**

**Before (vulnerable):**
```ts
await execAsync(
  `ffmpeg -i "${videoPath}" -i "${audioPath}" -c:v copy -c:a aac -shortest "${outputPath}"`
);
```

If `videoPath = '"; rm -rf /; echo "'`, this executes arbitrary shell commands.

**After (secure):**
```ts
function validatePath(path: string): void {
  if (SHELL_METACHARACTERS.test(path)) {
    throw new Error(
      `Path contains shell metacharacters: ${path}. ` +
      `This could enable command injection (CWE-78).`
    );
  }
}

await execFileAsync('ffmpeg', [
  '-i', videoPath,
  '-i', audioPath,
  '-c:v', 'copy',
  '-c:a', 'aac',
  '-shortest', outputPath
]);
```

**Why this is correct:**
1. ‚úÖ `execFileAsync` spawns process with argument array (no shell interpolation)
2. ‚úÖ `validatePath()` rejects shell metacharacters as defense-in-depth
3. ‚úÖ Works for both `combineVideoAudio` and `createAudioTimeline`
4. ‚úÖ Validates ALL paths (video, audio, output, clips)

**Zeroth Law compliance:** Security vulnerability fixed. No `eval()`, no shell interpolation.

---

### ‚úÖ Comprehensive Security Tests (149 lines)

**Test coverage:**

1. **Injection prevention** (7 test cases):
   - Malicious videoPath with command injection
   - Malicious audioPath
   - Malicious outputPath
   - Shell metacharacters: semicolon, pipe, backticks, dollar substitution
   - Malicious AudioClip path
   - Malicious output path in createAudioTimeline

2. **Functionality preservation** (1 test case):
   - Paths with spaces should still work

3. **Defense verification:**
   - Each test creates a marker file (e.g., `/tmp/PWNED`)
   - Test confirms marker file is NOT created (command didn't execute)
   - Uses real temp directories (`fs.mkdtemp`) for isolation

**Example test quality:**
```ts
it('should reject malicious path with command injection in videoPath', async () => {
  const maliciousPath = `"; touch "${maliciousMarkerFile}"; echo "`;

  await expect(
    combineVideoAudio(maliciousPath, testAudioFile, testOutputFile)
  ).rejects.toThrow();

  const markerExists = await fs.access(maliciousMarkerFile)
    .then(() => true)
    .catch(() => false);

  expect(markerExists).toBe(false);  // Verify command didn't execute
});
```

**Verdict:** Excellent test coverage. Tests verify actual command execution doesn't occur, not just that exceptions are thrown.

---

### ‚ö†Ô∏è But Tests Were Pushed While Failing

Already covered under **TDD** above. The comprehensive tests are excellent, but the process of writing them was broken.

---

### ‚úÖ Revert is Clean and Complete

**Evidence:**
- All 8 files from PR #269 removed or reverted
- No partial reverts or leftover code
- Changeset properly deleted
- No breaking changes introduced by revert

**Analysis:** The revert undoes the feature completely. No half-measures.

---

### ‚úÖ Audit Enforcement Policy Addition is Clear

**Added to RULES.md:**
```markdown
### Audit Grades Enforce Rework

Every merged PR gets audited. Bad grades have consequences:

| Grade | Action |
|-------|--------|
| **D** | **Mandatory rework.** Revert the PR and redo the work from scratch following strict TDD. Do NOT reuse the original code ‚Äî write it fresh, test-first. |
| **F** | **Mandatory revert + redo.** Same as D, but escalate to CTO. |

**Why no code reuse on D/F?** Because TDD isn't about having tests ‚Äî it's about the tests *driving* the implementation. Copying code and writing tests after is speculative testing.

**The process IS the product.** Code that works but was written without TDD is accidental correctness. We need *proven* correctness through red-green-refactor.
```

**Verdict:** Clear, well-explained policy. Correctly identifies why code reuse defeats TDD.

---

### ‚ùå Changeset Content is Correct But Timing is Wrong

**Changeset:**
```markdown
---
"@vertz/demo-toolkit": patch
---

fix(demo-toolkit): prevent shell injection in muxing commands by replacing shell interpolation with spawn()
```

**Good:**
- ‚úÖ Correct package (`@vertz/demo-toolkit`)
- ‚úÖ Correct severity (`patch` ‚Äî bug fix)
- ‚úÖ Clear description of what was fixed

**Bad:**
- ‚ùå Added 4 minutes after implementation (commit 4, not commit 1)

**Severity:** MINOR ‚Äî Changeset exists and is accurate, just not atomic.

---

## Security (Zeroth Law): ‚úÖ (Grade: A+)

### ‚úÖ Critical Vulnerability Fixed

**CWE-78 (OS Command Injection) Eliminated:**

**Attack vector (before):**
```ts
// Attacker controls videoPath
const videoPath = '"; rm -rf /tmp/important-data; echo "';
await execAsync(`ffmpeg -i "${videoPath}" ...`);
// Shell interprets: ffmpeg -i ""; rm -rf /tmp/important-data; echo "" ...
// Executes arbitrary commands!
```

**Mitigation (after):**
```ts
validatePath(videoPath);  // Throws error if shell metacharacters present
await execFileAsync('ffmpeg', ['-i', videoPath, ...]);  // No shell interpolation
```

**Severity:** CRITICAL ‚Äî This was a real RCE (Remote Code Execution) vulnerability if attackers could control file paths (e.g., via API endpoints, user uploads, or demo generation features).

---

### ‚úÖ Defense-in-Depth Applied

**Two layers of protection:**

1. **Primary defense:** `execFileAsync` with argument array (no shell)
2. **Secondary defense:** `validatePath()` rejects shell metacharacters

**Why both?**
- Even if `execFileAsync` API is misused in the future, validation provides a safety net
- Clear error messages help developers understand why certain paths are rejected
- Explicit CWE-78 reference in error message aids security awareness

---

### ‚úÖ Comprehensive Attack Surface Coverage

**All muxing entry points secured:**
- ‚úÖ `combineVideoAudio(videoPath, audioPath, outputPath)` ‚Äî 3 paths validated
- ‚úÖ `createAudioTimeline(clips[], duration, outputPath)` ‚Äî N+1 paths validated (all clip paths + output)

**Verification:** Tests cover all parameters in both functions.

---

### ‚úÖ No Hardcoded Secrets, No Eval

**Scan results:**
- ‚ùå No `eval()` or `new Function()`
- ‚ùå No hardcoded secrets
- ‚ùå No `as any` or type-safety bypasses
- ‚úÖ All file paths properly validated

---

### ‚úÖ Error Messages Don't Leak Sensitive Info

**Error message:**
```ts
throw new Error(
  `Path contains shell metacharacters: ${path}. ` +
  `This could enable command injection (CWE-78).`
);
```

**Analysis:**
- ‚úÖ Reveals the problematic path (necessary for debugging)
- ‚úÖ Explains WHY it's rejected (helps developers fix)
- ‚úÖ References CWE-78 (security awareness)
- ‚ùå No sensitive system info leaked (filesystem structure, secrets, etc.)

---

## Violations Summary

| Rule | Severity | Category | Description |
|------|----------|----------|-------------|
| **TDD: Test-First Cycle** | CRITICAL | TDD | Implementation + tests (222 lines) committed together. No red-green-refactor. |
| **TDD: Quality Gates Passed** | CRITICAL | TDD | Tests were FAILING (commit 6 fixes "failing test"). Code pushed with failing tests. |
| **Process: Scope Discipline** | CRITICAL | Process | PR bundles 4 unrelated concerns: security fix + revert + policy + audit. |
| **Process: Ticket Required** | MAJOR | Process | No ticket for security fix or revert work. |
| **Process: Audit Worktree** | MAJOR | Process | PR #277 audit files committed from main branch (worktree pollution). |
| **Design: No Ticket** | CRITICAL | Design | Absolute rule: "Never commit without a ticket." |
| **Process: Atomic Changesets** | MINOR | Process | Changeset added 4 minutes after implementation (commit 4, not 1). |

---

## Recommendations

### üö® IMMEDIATE: Revert This PR and Redo

**Per RULES.md Grade D policy (which this PR itself added):**

1. **Revert PR #280** ‚Äî All commits
2. **Create FOUR separate PRs:**

#### PR #280v2: Security Fix (URGENT ‚Äî Zeroth Law)
```bash
# Isolated worktree for security fix
git worktree add /tmp/worktrees/security-fix-muxing -b fix/shell-injection-muxing main
cd /tmp/worktrees/security-fix-muxing

# TDD cycle 1: First test
# Write: it('should reject malicious videoPath')
bun run test  # RED
# Implement: validatePath function
bun run test && bun run typecheck && bun run lint  # GREEN
git add -A && git commit -m "test: reject shell metacharacters in videoPath"

# TDD cycle 2: Apply to combineVideoAudio
# Write: test for all 3 params
bun run test  # RED
# Implement: validation in combineVideoAudio
bun run test && bun run typecheck && bun run lint  # GREEN
git commit -m "feat: validate all paths in combineVideoAudio"

# TDD cycle 3: Replace execAsync with execFileAsync
# Write: test that actual commands don't execute
bun run test  # RED
# Implement: execFileAsync with arg array
bun run test && bun run typecheck && bun run lint  # GREEN
git commit -m "refactor: replace execAsync with execFileAsync (spawn)"

# TDD cycle 4: Apply to createAudioTimeline
# ... repeat pattern

# Add changeset with commit (atomic)
git commit -m "chore: add changeset for shell injection fix" --allow-empty

git push origin fix/shell-injection-muxing
gh pr create --title "fix(demo-toolkit): prevent shell injection (CWE-78)" --body "..."
```

**Ticket:** `tickets/security/sec-001-shell-injection-muxing.md`

---

#### PR #281v2: Revert PR #269
```bash
git worktree add /tmp/worktrees/revert-269 -b revert/pr269-signal-unwrap main
cd /tmp/worktrees/revert-269

git revert 94fd13d  # PR #269 merge commit
git push origin revert/pr269-signal-unwrap
gh pr create --title "revert: PR #269 (Grade D audit)" --body "..."
```

**Ticket:** `tickets/rework/rework-001-signal-unwrap-revert.md`

---

#### PR #282v2: Add Audit Enforcement Policy
```bash
git worktree add /tmp/worktrees/audit-policy -b docs/audit-enforcement-policy main
cd /tmp/worktrees/audit-policy

# Edit RULES.md to add audit enforcement policy
git add RULES.md
git commit -m "docs(rules): add audit grade enforcement (D/F = mandatory rework)"
git push origin docs/audit-enforcement-policy
gh pr create --title "docs: add audit enforcement policy" --body "..."
```

**Ticket:** `tickets/docs/docs-NNN-audit-enforcement-policy.md`

---

#### PR #283v2: Audit of PR #277
```bash
# Auditor agent uses isolated worktree
git worktree add /tmp/worktrees/audit-pr277 -b audit/pr277 main
cd /tmp/worktrees/audit-pr277

cp /workspace/vertz/plans/audits/2026-02-14-pr277-agent.md plans/audits/
cp /workspace/vertz/plans/audits/data/2026-02-14-pr277-agent.json plans/audits/data/
git add plans/audits/
git commit -m "audit: PR #277 (vertz-tech-lead) - Grade C"
git push origin audit/pr277
gh pr create --title "audit: PR #277" --body "Grade C - scope violation + no ticket"
git worktree remove /tmp/worktrees/audit-pr277
```

**No ticket needed** (audits are self-documenting)

---

### For vertz-tech-lead (nora/mike) ‚Äî Process Training

1. **Re-read TDD rules** ‚Äî Focus on red-green-refactor cycle
   - `/workspace/vertz/.claude/rules/tdd.md`
   - `/workspace/backstage/.claude/rules/tdd-enforcement.md`

2. **Practice TDD on a small feature** ‚Äî Demonstrate incremental commits
   - Pick a simple feature (e.g., "add markdown to HTML converter")
   - Write ONE test ‚Üí RED ‚Üí implement ‚Üí GREEN ‚Üí commit
   - Repeat 5-10 times
   - Review commit history ‚Äî should show incremental progress

3. **Learn git worktree workflow** ‚Äî Never work in main repo directory
   ```bash
   git worktree add /tmp/worktrees/<feature> -b <branch> main
   cd /tmp/worktrees/<feature>
   # Work in isolation
   git worktree remove /tmp/worktrees/<feature>
   ```

4. **Scope discipline** ‚Äî ONE PR = ONE concern
   - Security fixes are urgent ‚Üí standalone PR
   - Reverts are administrative ‚Üí standalone PR
   - Audits are documentation ‚Üí standalone PR (isolated worktree)
   - Never bundle for convenience

5. **Never start work without a ticket** ‚Äî If none exists:
   - Create one yourself (if authorized)
   - Escalate to PM/CTO (if not authorized)
   - Do NOT proceed without ticket

---

### For CTO ‚Äî Process Enforcement

1. **Mandatory TDD training** ‚Äî vertz-tech-lead needs supervised practice
   - Pair session: Watch agent perform red-green-refactor live
   - Review commit history for incremental progress
   - Don't approve PRs until TDD demonstrated on practice feature

2. **Pre-push hooks enforcement:**
   ```yaml
   # .git/hooks/pre-push
   bun run test && bun run typecheck && bun run lint || exit 1
   ```
   - Make this mandatory in ALL worktrees
   - Document in PR template: "Hooks must pass"

3. **PR template checklist:**
   ```markdown
   - [ ] Ticket link: `tickets/...`
   - [ ] TDD followed (incremental commits, tests first)
   - [ ] Quality gates passed (test + typecheck + lint)
   - [ ] ONE concern (no scope creep)
   - [ ] Isolated worktree used (no contamination)
   ```

4. **CI check for failing tests in PR:**
   - GitHub Actions job: "Run tests on each commit in PR"
   - Fail PR if ANY commit had failing tests
   - This would have caught commit 1 ‚Üí commit 6 pattern

---

### For Auditor Agent ‚Äî Workflow Fix

**Current problem:** Auditor writes files to main workspace, other agents pick them up.

**Solution:**
```bash
# After finishing audit report, immediately isolate and PR it:

function publish_audit() {
  local pr_number=$1
  git worktree add /tmp/worktrees/audit-pr${pr_number} -b audit/pr${pr_number} main
  cd /tmp/worktrees/audit-pr${pr_number}
  
  # Copy ONLY audit files
  mkdir -p plans/audits/data
  cp /workspace/vertz/plans/audits/*-pr${pr_number}-*.md plans/audits/ 2>/dev/null || true
  cp /workspace/vertz/plans/audits/data/*-pr${pr_number}-*.json plans/audits/data/ 2>/dev/null || true
  
  git add plans/audits/
  git commit -m "audit: PR #${pr_number} - Grade X"
  git push origin audit/pr${pr_number}
  gh pr create --title "audit: PR #${pr_number}" --body "..."
  
  cd /workspace/vertz
  git worktree remove /tmp/worktrees/audit-pr${pr_number}
  
  # Clean up source files so they don't contaminate other branches
  rm /workspace/vertz/plans/audits/*-pr${pr_number}-*.md
  rm /workspace/vertz/plans/audits/data/*-pr${pr_number}-*.json
}

publish_audit 277
```

---

## Positive Notes

Despite severe process violations, several aspects demonstrate good engineering:

1. **üîí Security fix is critical and correct** ‚Äî CWE-78 eliminated
2. **üß™ Comprehensive security tests** ‚Äî 149 lines, 11 test cases, real temp files
3. **üõ°Ô∏è Defense-in-depth** ‚Äî Both spawn() and validation
4. **‚úÖ Revert is clean** ‚Äî All PR #269 changes properly undone
5. **üìù Clear policy documentation** ‚Äî Audit enforcement rationale explained
6. **üîç Self-awareness** ‚Äî Agent recognized PR #269 audit and attempted to address it

**The security work is excellent. The process is broken.**

---

## Grading Breakdown

| Category | Grade | Numeric | Weight | Rationale |
|----------|-------|---------|--------|-----------|
| **TDD Compliance** | F | 0 | 40% | Implementation + tests in one commit (222 lines). Failing tests pushed, fixed 13min later. Zero red-green-refactor. |
| **Quality Gates** | F | 0 | 15% | Tests were FAILING (commit 6 proves it). Code pushed with failing tests is cardinal sin. |
| **Git Process** | D | 1 | 15% | Scope violation (4 concerns bundled). Audit worktree pollution repeated. Changeset not atomic. |
| **Design Compliance** | F | 0 | 15% | No ticket (absolute rule). No design doc for multi-step revert strategy. |
| **DX/Quality** | C | 2 | 10% | Security fix is critical and correct. Comprehensive tests. But process broken. |
| **Security** | A+ | 4.5 | 5% | Critical vulnerability fixed (CWE-78). Defense-in-depth applied. Excellent test coverage. |

**Weighted Average:**
```
(0√ó0.40 + 0√ó0.15 + 1√ó0.15 + 0√ó0.15 + 2√ó0.10 + 4.5√ó0.05) = 0.575 / 4 = 0.14 = 14%
```

**Percentage to Letter Grade:**
- 90-100% ‚Üí A
- 80-89% ‚Üí B
- 70-79% ‚Üí C
- 60-69% ‚Üí D
- <60% ‚Üí F

**14% = F grade territory**

However, **Grade D is more appropriate** given:
- Code quality is good (security fix is correct)
- Violations are process/procedural, not functional
- Work can be salvaged with proper process redo

**Balancing factors:**
- ‚úÖ Security fix is urgent and correct (Zeroth Law weight)
- ‚ùå TDD violations are identical to the ones being "fixed"
- ‚ùå Irony: PR adds audit policy while violating it

**Final Grade: D** ‚Äî Mandatory rework required.

---

## Final Verdict

**Grade: D** ‚Äî Code is production-ready, but process violations are severe enough to require rework per the audit enforcement policy (which this PR itself introduced).

**Required action:**
1. ‚úÖ **Revert PR #280** (MANDATORY per Grade D policy)
2. ‚úÖ **Create 4 separate PRs** (security fix, revert, policy, audit)
3. ‚úÖ **Follow strict TDD** for security fix redo (incremental commits)
4. ‚úÖ **Create tickets** for all work (security + revert)
5. ‚úÖ **Use isolated worktrees** for audits

**Flag to CTO:** üö® **YES** (Grade D = mandatory flag)

**Escalation reason:** Agent repeated the EXACT violations it was supposed to be fixing:
- PR #269: TDD bypassed ‚Üí PR #280: TDD bypassed again
- PR #269: No ticket ‚Üí PR #280: No ticket
- PR #269: Worktree pollution (audit files) ‚Üí PR #280: Worktree pollution (audit files)

This suggests the agent doesn't understand WHY these rules exist, only that rules were violated. **Training required before next feature assignment.**

---

## Rework Required (Mandatory for Grade D)

### 1. What Must Be Reverted
- **Entire PR #280** ‚Äî All 6 commits
- Do NOT cherry-pick the security fix ‚Äî redo it from scratch with TDD

### 2. Tickets for Redo

#### Ticket 1: Security Fix
```markdown
tickets/security/sec-001-shell-injection-muxing.md

Title: Fix shell injection in muxing.ts (CWE-78)
Priority: URGENT (Zeroth Law - security)

Context: muxing.ts uses execAsync with template literals for FFmpeg
commands. If attacker controls file paths (via API, uploads, or demo
generation), they can inject shell commands.

POC: videoPath = '"; rm -rf /; echo "' executes arbitrary commands

Scope:
- Replace execAsync with execFileAsync (argument array, no shell)
- Add validatePath() to reject shell metacharacters
- Cover combineVideoAudio + createAudioTimeline
- Add security tests (try real injection attempts)

Out of scope:
- Other security issues (separate tickets)
- Unrelated muxing improvements

Acceptance:
- All file paths validated before use
- execFileAsync used (no shell interpolation)
- Tests prove injection attempts fail (no PWNED files created)
- Quality gates pass (test + typecheck + lint)
```

#### Ticket 2: Revert PR #269
```markdown
tickets/rework/rework-001-revert-pr269.md

Title: Revert PR #269 (signal auto-unwrap) ‚Äî Grade D audit
Priority: HIGH

Context: PR #269 received Grade D for TDD violations (all code in one
681-line commit, no red-green-refactor). Per audit enforcement policy,
Grade D requires revert + redo.

Scope:
- Revert commit 94fd13d (PR #269 merge)
- Remove signal-api-registry.ts
- Remove signal-object detection from reactivity-analyzer.ts
- Remove auto-unwrap from signal-transformer.ts
- Remove demo tests
- Remove changeset

Out of scope:
- Do NOT redo feature in same PR (separate ticket)
- Do NOT bundle unrelated work

Acceptance:
- All PR #269 changes reverted
- Tests pass (no broken references)
- Changeset removed
```

#### Ticket 3: Redo Signal Auto-Unwrap (TDD-Strict)
```markdown
tickets/compiler/comp-NNN-signal-auto-unwrap-tdd-redo.md

Title: Signal property auto-unwrap (TDD redo from scratch)
Priority: MEDIUM

Context: Original implementation (PR #269) violated TDD. Redo from
scratch following strict red-green-refactor. Do NOT reuse original code.

Original design: plans/signal-auto-unwrap.md (needs to be created)

Scope:
- Compiler auto-inserts .value for signal properties (query, form, createLoader)
- signal-api-registry.ts ‚Äî registry of known APIs
- reactivity-analyzer.ts ‚Äî detect signal-object variables
- signal-transformer.ts ‚Äî insert .value after signal properties
- Comprehensive tests (positive + negative cases)

TDD Checklist (MANDATORY):
‚ñ° Cycle 1: Test "detects query() as signal-object" ‚Üí implement
‚ñ° Cycle 2: Test "detects form() as signal-object" ‚Üí implement
‚ñ° Cycle 3: Test "auto-unwraps query().loading" ‚Üí implement
‚ñ° Cycle 4: Test "auto-unwraps form().submitting" ‚Üí implement
‚ñ° Cycle 5: Test "doesn't unwrap non-signal properties" ‚Üí implement
‚ñ° Cycle 6: Test "handles chained access (form.errors.name)" ‚Üí implement
‚ñ° Cycle 7: Test "handles aliased imports (import { query as q })" ‚Üí implement
‚ñ° ... (one test at a time, commit after each GREEN)

Acceptance:
- Incremental commit history (8+ commits, each with 1-2 tests + minimal impl)
- Quality gates pass before every commit
- Isolated worktree used
- Changeset added atomically
- Developer walkthrough passes (demo example works)
```

### 3. TDD Cycle to Follow

**Example first 3 cycles:**

```bash
# Setup
git worktree add /tmp/worktrees/signal-unwrap-tdd -b feat/signal-unwrap-tdd main
cd /tmp/worktrees/signal-unwrap-tdd

# ===== CYCLE 1: Detect query() as signal-object =====
# RED: Write test
echo "it('detects query() call as signal-object', () => { ... })" >> packages/ui-compiler/src/analyzers/__tests__/reactivity-analyzer.test.ts
bun run test  # FAILS ‚Äî signalProperties doesn't exist on VariableInfo

# GREEN: Minimal implementation
echo "signalProperties?: Set<string>;" >> packages/ui-compiler/src/types.ts
# Update analyzer to detect query() calls
bun run test  # PASSES
bun run typecheck && bun run lint  # PASSES

# COMMIT
git add -A
git commit -m "test: detect query() as signal-object"

# ===== CYCLE 2: Detect form() as signal-object =====
# RED: Write test
echo "it('detects form() call as signal-object', () => { ... })" >> packages/ui-compiler/src/analyzers/__tests__/reactivity-analyzer.test.ts
bun run test  # FAILS ‚Äî form not recognized

# GREEN: Minimal implementation
# Add form to registry
bun run test  # PASSES
bun run typecheck && bun run lint  # PASSES

# COMMIT
git add -A
git commit -m "feat: detect form() as signal-object"

# ===== CYCLE 3: Auto-unwrap query().loading =====
# RED: Write test
echo "it('auto-unwraps query() signal properties', () => { ... })" >> packages/ui-compiler/src/transformers/__tests__/signal-transformer.test.ts
bun run test  # FAILS ‚Äî no .value inserted

# GREEN: Minimal implementation
# Implement transformSignalObjectProperties in signal-transformer.ts
bun run test  # PASSES
bun run typecheck && bun run lint  # PASSES

# COMMIT
git add -A
git commit -m "feat: auto-unwrap signal properties"

# ... Continue for 8-10 cycles total
```

**Verification:**
```bash
# After all cycles complete:
git log --oneline | head -10
# Should show 8+ commits, each atomic, each with test + minimal impl

# Final checks:
bun run test && bun run typecheck && bun run lint  # All pass
git diff main --stat  # Review total changeset
```

### 4. Who Should Do the Rework

**Option A:** Different agent (preferred for learning)
- Assign to a different bot (e.g., ben-tech-lead or separate engineer agent)
- vertz-tech-lead observes and learns from proper TDD process

**Option B:** vertz-tech-lead with supervision (training opportunity)
- Require pre-approval before each commit (CTO reviews RED ‚Üí GREEN cycle)
- Session transcript captured and reviewed
- Training wheels until TDD internalized

### 5. Timeline

| Task | Priority | Estimated Duration | Owner |
|------|----------|-------------------|-------|
| Revert PR #280 | URGENT | 5 minutes | vertz-tech-lead |
| Security fix redo (TDD-strict) | URGENT | 2-3 hours (with TDD) | Supervised agent |
| Revert PR #269 (standalone) | HIGH | 10 minutes | vertz-tech-lead |
| Add audit policy (standalone) | MEDIUM | 30 minutes | vertz-tech-lead |
| Audit PR #277 (isolated worktree) | LOW | 15 minutes | auditor |
| Signal unwrap redo (TDD-strict) | MEDIUM | 4-6 hours (with TDD) | Different agent |

**Total:** Security fix within 24 hours (Zeroth Law priority), rest within 1 week.

---

## Audit Metadata

**Auditor:** agent:auditor (subagent)
**Session:** agent:auditor:subagent:b8e9da4f-48c5-423e-bd68-4fd291ef5545
**Audit Date:** 2026-02-14T17:49:00Z (immediately after PR merge)
**Audit Duration:** ~45 minutes
**Files Reviewed:** 14 (+930, -690)
**Diff Size:** 1,620 line changes
**Test Coverage:** 149 lines of security tests (excellent)
**Commits Analyzed:** 6 commits across 13 minutes

**Model:** anthropic/claude-sonnet-4-5-20250929
**Tokens Used:** ~40,000 (estimated)

**Prior Context:**
- Read auditor.md (grading criteria)
- Read RULES.md (current engineering rules)
- Read PR #269 audit (Grade D, triggering this revert)
- Analyzed PR #277 audit (Grade C, bundled in this PR)

**Note:** This audit itself must be published via isolated worktree per auditor.md. Do NOT bundle with other PRs. üòâ
