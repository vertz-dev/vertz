# Audit: PR #289 - Remove demo-toolkit Package

**Date:** 2026-02-15 | **Agent:** edson (vertz-devops) | **PR:** #289 | **Grade:** C

---

## Summary

PR #289 removes `@vertz/demo-toolkit` from the public vertz repository and relocates it to the private backstage repo where it belongs as internal tooling. The work accomplishes its goal but violates critical process rules around changeset requirements and worktree isolation.

**Key Findings:**
- ✅ Ticket exists and scope was followed
- ✅ Bot scripts used correctly
- ✅ Branch naming convention followed
- ✅ Atomic commits (lockfile separate)
- ❌ **MAJOR:** No changeset added for package removal
- ❌ **MAJOR:** Scope creep - unrelated file included in PR
- ❌ **MAJOR:** Worktree isolation violated

---

## TDD Compliance: N/A ⚠️

**Verdict:** Not Applicable (deletion only, no implementation)

### Analysis

This is a pure deletion PR - no new code was written. TDD rules don't apply to deletions, but verification of dependencies should have been performed.

**What was checked:**
- ✅ Package deletion is clean
- ✅ No broken imports (bun.lock updated)
- ⚠️ No explicit test showing "nothing depends on demo-toolkit" (though PR body claims this)

**Evidence:**
```
PR body: "No other packages in vertz depended on it"
```

This claim is correct - the diff shows only the package itself was removed, no other packages were touched.

**Finding:** No TDD violations. Deletions don't require tests, but dependency verification could have been more explicit (e.g., script output showing `bun test` still passes).

---

## Process: ❌

**Verdict:** Multiple Major Violations

### 1. ❌ **CRITICAL: No Changeset Added**

**Rule:** `pr-policies.md` — "Changeset required for any package change"

**Violation:** Package removal (`@vertz/demo-toolkit`) requires a changeset. None was added.

**Evidence:**
```bash
# Expected in .changeset/:
---
'@vertz/demo-toolkit': major
---

Remove @vertz/demo-toolkit (moved to backstage repo)
```

**No such file exists in the PR diff.**

**Impact:**
- Version bump will not be triggered
- Changelog will not be updated
- Consumers won't know this package was removed
- Violates semantic versioning process

**Recommendation:** Before ANY package is removed from the monorepo, a changeset MUST be created. Use:
```bash
bun changeset
# Select major for removed packages
```

### 2. ❌ **CRITICAL: Scope Creep - Unrelated File in PR**

**Rule:** `pr-policies.md` — "Isolated git worktree used" & "PR diff contains ONLY changes relevant to the ticket"

**Violation:** The PR includes an unrelated file not mentioned in the ticket:
- `plans/package-naming-strategy.md` (+476 lines)

**Evidence:**
```bash
$ gh pr diff 289 | grep "^diff --git" | grep -v "demo-toolkit"
diff --git a/bun.lock b/bun.lock
diff --git a/plans/package-naming-strategy.md b/plans/package-naming-strategy.md
```

The `package-naming-strategy.md` file is a design document unrelated to removing demo-toolkit. This is **classic scope creep** and proves the branch was NOT created from a clean, isolated worktree.

**Impact:**
- PR reviewer must evaluate TWO separate concerns (demo-toolkit removal + naming strategy)
- Violates single-responsibility principle for PRs
- Future `git blame` for package-naming-strategy.md will incorrectly point to this PR
- Difficult to revert if needed (which change do we revert?)

**Recommendation:**
1. The agent MUST use `git worktree add` to create an isolated branch:
   ```bash
   git worktree add /tmp/worktrees/pr289 -b chore/remove-demo-toolkit main
   cd /tmp/worktrees/pr289
   # Now make changes - no risk of picking up other files
   ```
2. The naming strategy doc should have been in a SEPARATE PR

### 3. ✅ Bot Scripts Used Correctly

**Evidence:**
```
Commit author: vertz-devops[bot] <2832183+vertz-devops[bot]@users.noreply.github.com>
```

The agent correctly used `git-as.sh` / `gh-as.sh` bot scripts. No personal credentials were leaked.

### 4. ✅ Branch Naming Convention Followed

**Evidence:**
```
Branch: chore/remove-demo-toolkit
```

Correct format: `chore/<description>`. ✅

### 5. ✅ Atomic Commits

**Evidence:**
```
Commit 1: "chore(demo-toolkit): remove package, moved to backstage repo"
Commit 2: "chore: update lockfile after removing demo-toolkit"
```

Lockfile update was separated from the main deletion. Good commit hygiene. ✅

### 6. ✅ Conventional Commit Format

**Evidence:**
```
chore(demo-toolkit): remove package, moved to backstage repo
chore: update lockfile after removing demo-toolkit
```

Both commits follow `type(scope): description` format. ✅

### 7. ⚠️ No Quality Gates Evidence

**Rule:** `RULES.md` — "Pre-push: bun run test && bun run typecheck && bun run lint"

**Issue:** No evidence in the PR body or commit messages that quality gates were run.

**Expected:**
```
✓ bun test (all tests pass)
✓ bun typecheck (no errors)
✓ bun lint (no violations)
```

**Finding:** Since this is a pure deletion, quality gates should still pass. However, there's no explicit evidence they were run before pushing.

**Recommendation:** Always include gate results in PR description:
```markdown
## Quality Gates
- ✅ `bun test` — all tests pass
- ✅ `bun typecheck` — no errors
- ✅ `bun lint` — clean
```

---

## Design Compliance: ✅

**Verdict:** Ticket followed correctly

### Analysis

**Ticket:** `chore-move-demo-toolkit-to-backstage.md`

**Ticket Requirements:**
1. Move `packages/demo-toolkit/` → backstage repo ✅
2. Remove from vertz workspace config ✅
3. Update imports/references (none existed) ✅
4. Verify nothing depends on demo-toolkit ✅

**Evidence:**
```
PR body: "No other packages in vertz depended on it"
Diff: Only demo-toolkit files deleted (+ bun.lock update)
```

The agent followed the ticket scope accurately. No deviation from requirements.

**Finding:** Design compliance is solid. ✅

---

## DX & Quality (The Laws): N/A ⚠️

**Verdict:** Not Applicable (internal package removal)

### Analysis

The demo-toolkit was **never a public API** - it was internal tooling that accidentally lived in the public repo. Therefore:
- Developer Walkthrough: N/A (not a feature)
- Vertical slices: N/A (not a feature)
- Examples: N/A (internal tooling)

**Finding:** DX rules don't apply to internal package removals.

---

## Security (Zeroth Law): ✅

**Verdict:** No security violations

### Analysis

**Potential Risks:**
1. Leaked secrets in deleted code? No - reviewed all source files
2. Sensitive data in binary files (MP3s)? No - demo audio files only
3. API keys hardcoded? No - used env vars correctly

**Evidence:**
```typescript
// tts.ts used environment variables correctly:
const apiKey = process.env.MINIMAX_API_KEY;
if (!apiKey) throw new Error('...');
```

**Finding:** No security concerns. ✅

---

## Grading Summary

| Category | Grade | Weight | Notes |
|----------|-------|--------|-------|
| TDD | N/A | - | Deletion only, no tests needed |
| Process | ❌ D | High | No changeset, scope creep, worktree violation |
| Design | ✅ A | Medium | Ticket followed correctly |
| DX | N/A | - | Internal tooling, not public API |
| Security | ✅ A | Critical | No violations |

**Overall Grade: C**

---

## Overall Assessment

**What Went Right:**
- Clean deletion - no broken dependencies
- Ticket scope followed accurately
- Bot scripts used correctly
- Atomic commits with good messages
- Branch naming correct

**What Went Wrong:**
- **MAJOR:** No changeset created for package removal
- **MAJOR:** Unrelated file (`package-naming-strategy.md`) included in PR
- **MAJOR:** Worktree isolation violated (proven by scope creep)
- **MINOR:** No explicit quality gate evidence

**Why Not a D or F?**
- The core work (deletion) is correct and functional
- No security violations
- No breaking changes to other packages
- Process violations are fixable and didn't cause downstream harm

**Why Not a B?**
- Missing changeset is a critical omission for monorepo management
- Scope creep is a process red flag that makes PR review harder
- These are not "minor" issues - they're fundamental process requirements

---

## Recommendations

### Immediate (For This PR)
1. **Add a changeset before merge** (if not already merged):
   ```bash
   bun changeset
   # Select: @vertz/demo-toolkit → major (removal)
   # Message: "Remove @vertz/demo-toolkit (moved to backstage)"
   ```

2. **Extract the naming strategy doc into a separate PR:**
   ```bash
   git revert <commit-with-naming-doc>
   # Open new PR: docs/package-naming-strategy
   ```

### For Future Work
1. **Always use isolated worktrees for PRs:**
   ```bash
   git worktree add /tmp/worktrees/feature-x -b feat/feature-x main
   cd /tmp/worktrees/feature-x
   # Make changes here - no contamination from main workspace
   git add . && git commit -m "..."
   git push origin feat/feature-x
   cd - && git worktree remove /tmp/worktrees/feature-x
   ```

2. **Always add changesets for package changes:**
   - New feature → minor
   - Breaking change → major
   - Bug fix → patch
   - **Package removal → major**

3. **Run quality gates explicitly and document results:**
   ```markdown
   ## Quality Gates
   \`\`\`
   $ bun test
   ✓ All tests pass

   $ bun typecheck
   ✓ No type errors

   $ bun lint
   ✓ No violations
   \`\`\`
   ```

4. **Review PR diff before opening:**
   ```bash
   git diff main...HEAD --name-status
   # Verify ONLY ticket-related files are present
   ```

---

## Lessons Learned

### For the Agent (edson)
- Package changes ALWAYS need changesets (even removals)
- One PR = one concern (don't mix unrelated changes)
- Use worktrees to prevent scope creep

### For the Team
- Consider a pre-push hook that checks for changesets when `package.json` files are modified
- Enforce worktree usage via documentation or tooling
- Add PR template checklist:
  ```markdown
  - [ ] Changeset added (if package changed)
  - [ ] Quality gates passed
  - [ ] PR contains only ticket-related changes
  ```

---

## Conclusion

PR #289 accomplishes its goal (removing demo-toolkit from the public repo) but violates critical process requirements around changesets and worktree isolation. The work is functionally correct, but the process failures indicate the agent didn't fully internalize the monorepo management rules.

**Grade: C** — Significant process violations, but functional work is correct. No rework required, but the agent must improve changeset discipline and worktree isolation for future work.

---

**Audit complete.**  
**Next Steps:** Flag this audit to CTO (grade < B) and ensure edson reads the changeset and worktree isolation rules before the next PR.
