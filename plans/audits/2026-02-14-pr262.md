# Audit: PR #262 — feat(task-manager): Implement REAL SSR with Vite

**Date:** 2026-02-14  
**Agent:** vertz-dev-core (bot)  
**PR:** #262  
**Merged:** 2026-02-14 11:03 UTC  
**Grade:** C+

---

## Executive Summary

PR #262 successfully proved that SSR works in the vertz framework with +2,679 lines of implementation across 45 files. The technical implementation is solid, with comprehensive tests and proper error handling. However, the PR suffers from **significant scope management issues** and **failed to deliver on the user-facing DX promise** — as documented in the subsequent retrospective (`plans/retro-ssr-dx-gap.md`).

**Key Issues:**
1. ❌ Scope creep: PR includes demo-toolkit package (automation feature) unrelated to SSR
2. ❌ Scope creep: Type safety fixes across 8+ test files not mentioned in PR title
3. ⚠️ No changeset for package changes (demo-toolkit, ui-server dependency updates)
4. ⚠️ Unable to verify TDD compliance due to missing session transcript
5. ⚠️ Developer Walkthrough gate missing (addressed in retro)
6. ⚠️ Example requires 400+ lines of boilerplate (not using framework's public API)

**Strengths:**
- ✅ Comprehensive test coverage for new SSR components
- ✅ Proper bot usage (vertz-dev-core)
- ✅ No security violations
- ✅ Type-safe implementation with proper error handling

---

## TDD Compliance: ⚠️ Cannot Verify

### Assessment

**Unable to audit TDD process due to missing session transcript.** The auditor soul requires `sessions_history` access to verify the order of file creation (tests before implementation), but this tool is not available in the current session.

### Evidence from Diff

**Positive indicators:**
- All new implementation files have corresponding test files:
  - `dom-shim.ts` → `__tests__/dom-shim.test.ts` (243 lines)
  - `jsx-runtime-server.ts` → `__tests__/jsx-runtime-server.test.ts` (162 lines)
  - `entry-server.ts` → `__tests__/ssr.test.ts` (81 lines)
  - `dev-server.ts` → `__tests__/dev-server.test.ts` (39 lines)
- Tests are comprehensive and check both positive and negative cases

**Negative indicators:**
- `routing-bug.test.ts` includes comment: *"Test to reproduce routing bug found in PR #262 review"*
  - This suggests the bug was discovered AFTER implementation
  - Bug fix test written retroactively (not TDD)
  - Lines 5-7: "Issue: The router isn't matching routes in SSR because window.location.pathname isn't updated correctly between renders when modules are cached."

**Type safety improvements across 8 test files:**
```diff
- expect(parent.children[0]!.tagName).toBe('P');
+ expect(parent.children[0]?.tagName).toBe('P');

- await changeHandler!({ matches: true });
+ await changeHandler?.({ matches: true });

- text.data = span as any;
+ text.data = span as unknown as string;
```

These changes suggest:
1. TypeScript strict null checks were enabled or enforced AFTER tests were written
2. OR: Tests were written without proper type safety initially
3. This is retrofitting, not test-first development

### Quality Gates

**Cannot verify** whether `bun run test && bun run typecheck && bun run lint` was run before each commit without git history inspection. The diff shows the end state passed all gates (PR was merged), but the process cannot be audited.

### Recommendation

**Critical for future audits:** Implement session transcript capture for all bot PRs. Without this, TDD compliance is unauditable, which defeats the purpose of having an auditor.

---

## Process: ⚠️ Multiple Issues

### Git & PR Workflow: ✅ Mostly Correct

**✅ Correct:**
- Bot identity used properly (`vertz-dev-core`)
- Merged via PR (not direct push to main)
- PR title follows convention: `feat(task-manager): ...`

**❌ Missing:**
- No changeset detected in the diff for:
  - New package: `@vertz/demo-toolkit`
  - Dependency updates: `examples/task-manager` now depends on `@vertz/ui-server`
  - `packages/ui-server/package.json` adds `peerDependencies: { "vite": "^6.0.0" }`

**Evidence:**
```diff
# bun.lock shows new package added
+ "packages/demo-toolkit": {
+   "name": "@vertz/demo-toolkit",
+   "version": "0.0.0",
```

But no `.changeset/*.md` file in the diff.

**⚠️ Cannot verify:**
- Whether isolated git worktree was used (requires git history, not visible in diff)
- Whether commits were atomic (requires git log)
- Whether the PR diff contains ONLY relevant changes (mostly yes, but demo-toolkit is questionable)

### Scope Management: ❌ Significant Violations

**PR title:** "feat(task-manager): Implement REAL SSR with Vite"

**Expected scope:** SSR implementation for task-manager example (aligned with ui-010-ssr ticket)

**Actual scope in PR:**

1. ✅ **SSR implementation** (in-scope):
   - `examples/task-manager/src/dom-shim.ts` (384 lines)
   - `examples/task-manager/src/jsx-runtime-server.ts` (120 lines)
   - `examples/task-manager/src/entry-server.ts` (127 lines)
   - `examples/task-manager/src/entry-client.ts` (30 lines)
   - `examples/task-manager/src/server.ts` (14 lines)
   - SSR tests (537 lines across 4 test files)
   - Router SSR compatibility fixes (`router.ts`: 10 lines changed)

2. ❌ **Demo automation toolkit** (OUT OF SCOPE):
   - `packages/demo-toolkit/` — entire new package (1,100+ lines)
   - README, package.json, CLI, recorder, script runner, types, tests
   - Task-manager demo script
   - **This is a completely separate feature** with no direct relationship to SSR
   - Should have been a separate PR/ticket

3. ❌ **Type safety improvements across unrelated test files** (OUT OF SCOPE):
   - 8 test files modified in `packages/ui`, `packages/cli`, `packages/compiler`
   - Changes: `!` → `?`, `as any` → `as unknown as T`, `expect(x!)` → `expect(x?)`
   - ~50 lines of non-null assertion fixes
   - **These are technical debt cleanup, not SSR work**
   - Should have been a separate PR/ticket: "chore: improve test type safety"

4. ⚠️ **Dev server abstraction** (BORDERLINE):
   - `packages/ui-server/src/dev-server.ts` (259 lines)
   - This IS related to SSR, but it's reusable infrastructure
   - Should probably have been its own ticket: "feat(ui-server): add Vite dev server abstraction"
   - Acceptable to include if documented in the design, but scope is growing large

**Severity:** MAJOR

**Recommendation:** 
- Demo-toolkit should have been PR #263 (separate ticket)
- Type safety fixes should have been PR #264 or bundled into a "chore" commit
- One feature = one PR = one review = one rollback if needed

### Design Doc Compliance: ✅ Mostly Aligned

**Design doc:** `plans/ssr-zero-config.md` (read during audit)

**Ticket:** `tickets/vertz-ui/ui-010-ssr.md` (read during audit)

**Alignment:**
- ✅ Implements SSR for task-manager example (ticket goal)
- ✅ DOM shim approach matches design sketch
- ✅ Server-side JSX runtime matches design
- ✅ Vite dev server integration started (dev-server.ts)
- ⚠️ BUT: The design doc (`ssr-zero-config.md`) explicitly calls out that the task-manager boilerplate approach is WRONG:

From the design doc:
> "SSR in vertz today requires developers to:
> 1. Write a custom entry-server.ts (~100 lines)
> 2. Write a custom server.ts that creates Vite in middleware mode
> 3. Write a separate JSX runtime for the server
> This is **unacceptable DX**."

**The PR implements exactly the "unacceptable DX" approach.**

This is not necessarily a violation — the design doc was likely written AFTER discovering this gap (confirmed by the retro). The PR proved SSR *works*, and the design doc defines how to make it *usable*. This is a valid phased approach.

**However:** The PR should have been titled differently to set expectations:
- Current: "feat(task-manager): Implement REAL SSR with Vite" (implies production-ready)
- Better: "feat(task-manager): SSR proof-of-concept with manual wiring" (honest about state)

**Deviation Escalation:** 
- The design doc (zero-config SSR) is aspirational, not prescriptive for THIS PR
- The PR implements Phase 1 of the journey
- No formal design doc was violated, but the DX gap was identified post-merge (retro)
- ✅ Design doc was created to address the gap (correct escalation)

---

## Design & DX: ❌ Missing Critical Gate

### Developer Walkthrough: Not Performed

**From RULES.md:**
> "Every feature ticket MUST include a Developer Walkthrough section. The feature is NOT done until this walkthrough passes end-to-end."

**Ticket ui-010-ssr did include acceptance criteria but they tested INTERNALS, not user outcomes:**
- ✅ "renderToStream() returns a ReadableStream of valid HTML"
- ✅ "Suspense boundaries emit placeholder first"
- ✅ "Interactive components get data-v-id markers"

**Missing criterion:**
- ❌ "Developer adds `ssr: true` to vite.config.ts and runs `vite dev`"
- ❌ "View source in browser shows rendered HTML"
- ❌ "No manual wiring required"

**Evidence from the retro (`retro-ssr-dx-gap.md`):**
> "We tested that the engine works. We never tested that a human can use the engine."

> "Nobody ran through the flow as a new developer would..."

> "The example should have been the RED flag, not the GREEN flag. When your demo needs 400 lines of glue code to use a framework feature, the feature isn't done."

**Severity:** MAJOR

The framework shipped SSR primitives but not a usable SSR feature. This is a **Definition of Done** violation.

### Example Uses Private/Internal APIs: ❌ Violation

**From RULES.md:**
> "Examples must use only the public API — if an example imports internal modules, writes custom glue code, or needs a different dev command than documented, that's a framework bug, not a feature of the example."

**task-manager example now requires:**
1. Custom `dom-shim.ts` (384 lines) — not exported by `@vertz/ui-server`
2. Custom `jsx-runtime-server.ts` (120 lines) — not in framework
3. Custom `entry-server.ts` (127 lines) — manual router wiring
4. Custom `server.ts` (14 lines) — bypasses `vite dev`

**Total:** 645 lines of boilerplate to use SSR.

This violates the "vertical slice" principle:
> "Primitives without integration are not features. Never ship a 'Phase N: internals' without also shipping the integration that makes it usable."

**Severity:** MAJOR (but acknowledged in retro and plan created to fix)

---

## Quality: ✅ Strong Test Coverage

### Test Coverage: ✅ Excellent

**New test files:**
1. `dom-shim.test.ts` (243 lines) — comprehensive DOM shim coverage
   - createElement, appendChild, removeChild, classList, style, attributes
   - Edge cases: null children, fragment flattening, parent tracking
   
2. `jsx-runtime-server.test.ts` (162 lines) — JSX → VNode transformation
   - Simple elements, nested children, event handler stripping
   - Boolean attributes, data attributes, aria attributes
   - Component function calls, Fragment handling
   
3. `ssr.test.ts` (81 lines) — integration tests
   - Complete HTML document rendering
   - Real component content (TaskListPage)
   - Navigation links, theme provider, script tags
   
4. `routing-bug.test.ts` (51 lines) — regression test
   - Router matching in SSR context
   - Multiple routes tested
   
5. `dev-server.test.ts` (39 lines) — dev server API
   - Configuration validation
   - listen/close methods
   
**Total:** 576 lines of new test code for SSR implementation

**Existing test improvements:** 50+ lines of type safety fixes across 8 test files

**Assessment:** Test coverage is thorough. Each component has both unit and integration tests. Edge cases are covered.

### Type Safety: ✅ Improved

**Changes demonstrate good type hygiene:**
```typescript
// Before: Unsafe non-null assertion
expect(parent.children[0]!.tagName).toBe('P');

// After: Safe optional chaining
expect(parent.children[0]?.tagName).toBe('P');

// Before: Dangerous type erasure
text.data = span as any;

// After: Explicit cast with intent
text.data = span as unknown as string;
```

**However:** These fixes suggest the original tests were written with looser type checking. This is acceptable for rapid prototyping, but should be caught in review.

### Documentation: ⚠️ Minimal

**Added:**
- `packages/demo-toolkit/README.md` (167 lines) — good documentation for demo toolkit

**Missing:**
- No update to `examples/task-manager/README.md` explaining SSR setup
- No documentation of the 5 new files required for SSR
- No "how to run SSR" guide

**This is acceptable IF the plan is to replace the manual wiring with zero-config** (which it is, per `ssr-zero-config.md`). Documenting temporary boilerplate would be wasted effort.

---

## Security: ✅ No Issues

**Scanned for:**
- ❌ `eval()` / `new Function()` — none found
- ❌ Hardcoded secrets — none found
- ❌ Unsafe input handling — all user input is URL paths, properly handled

**DOM shim security:**
- ✅ No innerHTML parsing (just assignment)
- ✅ No script injection vectors
- ✅ Proper escaping delegated to `@vertz/ui-server` (existing, audited)

**Severity:** NONE

---

## Recommendations

### For This PR (Retroactive)

1. **Split into 3 PRs:**
   - PR #262: SSR implementation (task-manager + ui-server dev-server)
   - PR #263: demo-toolkit package
   - PR #264: type safety improvements across tests

2. **Add changeset** for:
   - `@vertz/demo-toolkit` (new package)
   - `@vertz/ui-server` (peerDependencies change)
   - `examples/task-manager` (new dependency)

3. **Document the boilerplate gap** in the PR description:
   - "This PR proves SSR works but requires manual wiring"
   - "Follow-up: zero-config SSR (issue #265)"

### For Future PRs

1. **Enforce Developer Walkthrough gate** (now in RULES.md):
   - Reviewer must verify a fresh-start test was performed
   - If the example needs boilerplate, flag it

2. **Scope discipline:**
   - One feature per PR (SSR, demo toolkit, type fixes are 3 separate features)
   - If you discover scope creep during implementation, **stop and split the PR**

3. **Session transcripts for bot PRs:**
   - TDD compliance is unauditable without session history
   - Implement `sessions_history` capture or equivalent

4. **Changeset enforcement:**
   - Add a pre-push hook or CI check that fails if package changes lack a changeset

---

## Grading

### Breakdown

| Category | Grade | Weight | Notes |
|----------|-------|--------|-------|
| **TDD** | ? | 30% | Cannot verify; routing bug suggests retroactive fix |
| **Process** | C | 25% | Missing changeset, scope creep, otherwise correct |
| **Design** | B | 20% | Implements ticket correctly; DX gap acknowledged |
| **Quality** | A | 15% | Excellent tests, type-safe, well-structured |
| **Security** | A | 10% | No violations |

### Overall Grade: **C+**

**Rationale:**
- The work is technically solid and demonstrates SSR works (Quality: A)
- Process violations are significant: scope creep (demo-toolkit), missing changeset, type fixes bundled in (Process: C)
- Design gap (400 lines of boilerplate) was identified and escalated correctly, with a plan to fix (Design: B)
- TDD compliance is unknown but routing bug suggests some retroactive fixes (TDD: ?)
- Security is clean (Security: A)

**Why not B?** Scope creep is a MAJOR violation. This PR should have been 3 separate PRs. The bundling makes review harder, increases risk, and obscures the actual changes.

**Why not D?** The technical implementation is strong, tests are comprehensive, and the DX gap was properly escalated with a corrective plan. The retro is exemplary — this is how teams learn and improve.

---

## Lessons Learned (from retro)

The retrospective (`retro-ssr-dx-gap.md`) is outstanding and already documents the key lessons:

1. **Primitives ≠ Features** — Shipping `renderToStream()` is not the same as shipping SSR support
2. **Acceptance criteria must test user outcomes** — Not just "API returns X" but "developer can do Y"
3. **Vertical slices > Horizontal layers** — Don't build all primitives then all integrations; build one feature end-to-end
4. **Examples are smoke tests** — If the example needs 400 lines of glue, the API isn't ready
5. **"Use it" gate** — Someone must use the feature from scratch before marking it complete

**These lessons are now encoded in RULES.md.** This audit confirms they are being applied going forward.

---

## Action Items

### Immediate (Post-Merge Cleanup)

- [ ] Add changeset for `@vertz/demo-toolkit` (patch/minor as appropriate)
- [ ] Add changeset for `@vertz/ui-server` peerDependencies update
- [ ] Document in PR #262 comments: "Follow-up required for zero-config SSR (tracked in #265)"

### Short-Term (Next Sprint)

- [ ] Implement zero-config SSR per `plans/ssr-zero-config.md` (assigned to Ben, issue #265)
- [ ] Remove task-manager boilerplate files once framework integration is complete
- [ ] Audit all "✅ Complete" tickets for similar DX gaps (do they pass the "use it" gate?)

### Process Improvements (Ongoing)

- [x] Add Developer Walkthrough requirement to RULES.md (done)
- [x] Add vertical slice guidance to RULES.md (done)
- [ ] Implement session transcript capture for TDD auditing
- [ ] Add changeset check to CI/pre-push hooks

---

## Auditor Notes

This audit was challenging due to:
1. Missing session transcript (TDD compliance unverifiable)
2. Large PR (+2,679 lines) with multiple concerns mixed together
3. Retro was written AFTER the PR merged, which is unusual but valuable

**Positive aspects:**
- The retro is exemplary — honest, specific, actionable
- The team identified the DX gap and created a corrective plan
- The technical work is high quality
- Security and testing are strong

**Overall:** This PR is a **learning milestone**. The work quality is good, but the process needs tightening (scope management, changeset discipline). The DX gap was a valuable lesson that has been encoded into the team's rules.

**Grade justified:** C+ reflects "significant violations but work is functional, with proper escalation and corrective action."

---

**Audit completed:** 2026-02-14  
**Auditor:** auditor (subagent)  
**Confidence:** High (limited by missing session transcript)
