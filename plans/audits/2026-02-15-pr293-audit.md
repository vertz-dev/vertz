# Audit: fix(ui-compiler): SSR routing — correct URL normalization and middleware order

**Date:** 2026-02-15 | **Agent:** ben (auditor) | **PR:** #293 | **Grade:** A

## Executive Summary

PR #293 fixes a critical SSR bug where all routes rendered "Page not found" due to Vite's SPA fallback rewriting URLs before the SSR middleware could handle them. The fix is clean, well-scoped (342 additions, 74 deletions across 4 files), and follows TDD with clear RED/GREEN commits. No security concerns. Test coverage is thorough. The changeset and PR body are exemplary.

**Result:** Grade A — high-quality bug fix with proper TDD process, good test coverage, and clear documentation.

---

## TDD Compliance: ✅ **PASSED**

### Findings

**RED/GREEN commits verified (POSITIVE)**
- RED commit (`168bfad`): Failing tests for middleware order, URL normalization, targeted invalidation
- GREEN commit (`cb3b953`): Implementation + changeset
- This is textbook TDD — tests written first, then made to pass

**Test coverage is comprehensive (POSITIVE)**
- ✅ New dedicated test file `vite-plugin-ssr-routing.test.ts` (239 lines) with 5 behavioral tests:
  - Pre-hook middleware registration (not post-hook)
  - Root URL `/` renders correctly
  - Deep routes `/about` render correctly
  - URL passed to `renderToString` is `/`, not `/index.html`
  - Module invalidation per request prevents stale router state
- ✅ Existing test in `vite-plugin-ssr.test.ts` updated to reflect new pre-hook behavior
- ✅ Tests are behavioral, not implementation-detail tests — they verify what the middleware does, not how

**All 243 ui-compiler tests pass (per PR body)**

---

## Code Quality: ✅ **GOOD**

### Changes Reviewed

**1. Middleware registration (pre-hook pattern) — CORRECT**
- Changed from returning a function (post-hook) to calling `server.middlewares.use()` directly
- This ensures SSR middleware runs BEFORE Vite's SPA fallback
- The root cause analysis is accurate and well-documented in both code comments and PR body

**2. URL normalization in SSR entry — CORRECT, DEFENSE-IN-DEPTH**
- Strips `/index.html` suffix in `renderToString()` generated code
- This is a safety net — with the pre-hook fix, URLs should already be clean
- Good defensive programming practice

**3. Surgical module invalidation — CORRECT, PERFORMANCE IMPROVEMENT**
- Changed from invalidating the entire module graph to `getModuleById('\0vertz:ssr-entry')` — O(1) vs O(n)
- Only the virtual SSR entry module is invalidated per request
- This is both a correctness fix (prevents stale router state) and a performance improvement

### Minor Observations

- The `readFileSync` and `resolve` imports inside the middleware handler (dynamic `import('node:fs')`) were pre-existing, not introduced by this PR. Not ideal for performance (dynamic import on every request) but out of scope.
- The regex for skipping asset URLs is reasonable but could miss some edge cases (e.g., `.ico`, `.mp4`). Pre-existing, not a regression from this PR.

---

## Security Implications: ✅ **NONE**

- No new user input handling — URL comes from `req.url` which is already server-controlled
- URL normalization only strips a known suffix (`/index.html`), no injection risk
- Module invalidation is scoped to a known virtual module ID
- No new dependencies introduced

---

## Potential Regressions: ✅ **LOW RISK**

- **Pre-hook vs post-hook**: The main behavioral change. Pre-hook means the SSR middleware now runs before Vite's built-in middleware. The skip logic (non-HTML requests, Vite internals, assets) is preserved and should correctly pass through non-SSR requests. This is the documented correct approach for SSR in Vite.
- **Module invalidation**: Only invalidates the SSR entry module, not user code modules. HMR for user code still works through Vite's normal channel. If the module isn't found (`getModuleById` returns undefined), the code gracefully skips invalidation.

---

## Git & PR Process: ✅ **PASSED**

- ✅ Atomic commits: RED (tests) → GREEN (implementation) — clean TDD flow
- ✅ Changeset included with appropriate `patch` bump
- ✅ PR body is detailed: documents root cause, fix approach, performance impact, TDD process
- ✅ PR author is `vertz-dev-core` bot — consistent with automated tooling
- ⚠️ No Linear ticket ID in commit messages (uses `fix-ssr-route-rendering` slug instead) — minor deviation from commit conventions but ticket reference is present in changeset and PR body

---

## Grade Justification

| Criterion | Rating |
|-----------|--------|
| TDD compliance | ✅ Verified RED/GREEN |
| Test coverage | ✅ 239 lines of new behavioral tests |
| Code quality | ✅ Clean, well-commented, correct |
| Security | ✅ No concerns |
| Regression risk | ✅ Low |
| Process | ✅ Good (minor ticket ID note) |

**Overall: A** — This is how bug fixes should be done: clear root cause analysis, TDD process, behavioral tests, surgical fix, good documentation.
