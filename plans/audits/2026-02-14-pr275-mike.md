# Audit: MiniMax Speech API Integration with Voice Cloning

**Date:** 2026-02-14 | **Agent:** mike (vertz-tech-lead) | **PR:** #275 | **Grade:** F

**Reviewer:** auditor | **Session:** Unable to locate agent session transcript

---

## Executive Summary

PR #275 adds MiniMax Speech API integration to demo-toolkit, replacing shell-based TTS with direct API calls and adding voice cloning capabilities. The implementation includes comprehensive tests (23 total), excellent documentation, and well-thought-out modular architecture. However, **the PR contains critical security vulnerabilities that constitute automatic failure** per engineering rules.

**Critical Issue:** The new `muxing.ts` module uses shell string interpolation with user-provided paths, creating command injection vulnerabilities (CWE-78). This violates the Zeroth Law (Security is non-negotiable) and results in an automatic F grade regardless of other quality metrics.

---

## Overall Grade: F

**Rationale:** Per audit rules: *"A single critical security violation is an automatic F in audits, regardless of other quality."* The shell command injection vulnerability in `muxing.ts` is explicitly forbidden in RULES.md under the Zeroth Law (Security).

**Stats:**
- Lines changed: +1,807 / -105
- Files changed: 10
- Commits: 3
- Tests: 23 (16 TTS, 7 muxing)
- Review: Approved by viniciusdacal (2026-02-14T17:12:03Z)

---

## üî¥ Security: F (CRITICAL VIOLATION)

### ‚ùå CRITICAL: Shell Command Injection (CWE-78)

**Location:** `packages/demo-toolkit/src/muxing.ts`

**Violations:**

1. **Line 57-59** - `combineVideoAudio()`:
```typescript
await execAsync(
  `ffmpeg -i "${videoPath}" -i "${audioPath}" -c:v copy -c:a aac -shortest "${outputPath}"`,
);
```

2. **Line 105-110** - `createAudioTimeline()`:
```typescript
const inputs = clips.map((clip) => `-i "${clip.audioPath}"`).join(' ');
// ...
await execAsync(
  `ffmpeg ${inputs} -filter_complex "${filterComplex}" -t ${duration / 1000} "${outputPath}"`,
);
```

**Issue:** Both functions use `execAsync()` (promisified `exec()`) with template literals containing user-controllable file paths. This allows command injection if an attacker controls file paths.

**RULES.md violation:**
> "No shell string interpolation ‚Äî never use `execAsync()` or `exec()` with template literals. Always use `spawn()` with argument arrays: `spawn('cmd', ['--arg', value])`. This prevents command injection (CWE-78)."

**Exploitation scenario:**
```typescript
const maliciousPath = 'input.mp4"; rm -rf / #';
await combineVideoAudio(maliciousPath, 'audio.mp3', 'output.mp4');
// Executes: ffmpeg -i "input.mp4"; rm -rf / #" -i "audio.mp3" ...
```

**Severity:** CRITICAL - This is a Zeroth Law (Security) violation. Security gates may add friction, but they are non-negotiable.

**Evidence:** Diff shows both violations were introduced in commit `855aba5` ("refactor(demo-toolkit): separate TTS and muxing modules").

### Recommendation

**Immediate action required:**
1. Replace all `execAsync()` calls with `spawn()` using argument arrays
2. Never interpolate user input into shell commands

**Correct implementation:**
```typescript
import { spawn } from 'node:child_process';
import { promisify } from 'node:util';

const spawnAsync = promisify(spawn);

// Safe: Arguments are passed as array
await spawnAsync('ffmpeg', [
  '-i', videoPath,
  '-i', audioPath,
  '-c:v', 'copy',
  '-c:a', 'aac',
  '-shortest',
  outputPath
]);
```

---

## ‚ö†Ô∏è TDD: C (UNABLE TO VERIFY COMPLIANCE)

### ‚ö†Ô∏è Unable to Verify TDD Order

**Issue:** No agent session transcript found to verify that tests were written before implementation.

**Evidence searched:**
- `/workspace/agents/mike/` - No memory or session logs
- `/workspace/agents/kai/` - No memory or session logs (git author shows kai@vertz.dev)
- Git history shows all commits on 2026-02-14 between 17:02:42Z and 17:10:55Z

**What we can verify:**
- ‚úÖ Comprehensive test coverage exists (23 tests total)
- ‚úÖ Tests cover all major functionality (TTS, voice cloning, error handling, muxing)
- ‚úÖ Tests use proper mocking (fetch, child_process)
- ‚úÖ Tests validate both positive and negative cases

**What we cannot verify:**
- ‚ùå Whether tests were written BEFORE implementation
- ‚ùå Whether red-green-refactor cycle was followed
- ‚ùå Whether quality gates (`bun run test && typecheck && lint`) were run before each commit

**Test files:**
1. `packages/demo-toolkit/tests/tts.test.ts` - 16 tests
   - Basic TTS generation
   - Custom options (voice, speed, model)
   - Voice cloning
   - Error handling (401, 429, network failures)
   - Endpoint fallback logic

2. `packages/demo-toolkit/tests/muxing.test.ts` - 7 tests
   - Module structure validation
   - Type definitions
   - Function signatures

**Grading:** Without session transcript evidence, cannot confirm TDD compliance. However, the final test quality is good. Grade assumes tests may have been retrofitted (C).

### Recommendation

For future audits:
1. Preserve agent session logs in `/workspace/agents/<agent>/memory/YYYY-MM-DD.md`
2. Include session metadata in PR description
3. Agents should self-document TDD steps in commit messages

---

## ‚ö†Ô∏è Process: D (MAJOR VIOLATIONS)

### ‚ùå No Ticket Found

**Issue:** No specific ticket exists for this feature.

**Evidence:**
- Searched `/workspace/vertz/tickets/` - No MiniMax or TTS integration ticket
- Found only `tickets/chore-move-demo-toolkit-to-backstage.md` which *references* PR #275 but was created after the PR

**RULES.md violation:**
> "Never commit without a ticket"

**Mitigation:** The feature is referenced in a later cleanup ticket, suggesting it was planned but documentation is missing.

### ‚ö†Ô∏è Cannot Verify Git Worktree Isolation

**Issue:** Without session transcript, cannot verify if an isolated git worktree was used.

**Why this matters:** PR diff contains only demo-toolkit changes (good), but auditor rules require: *"Never create an audit branch from the main repo working directory. If you do, you risk including staged/unstaged changes from other agents' work."*

**What we can see:**
- ‚úÖ All 10 changed files are within `packages/demo-toolkit/` scope
- ‚úÖ No stray files from other features
- ‚úÖ Clean, focused diff

**Assumption:** Likely used proper isolation (evidence suggests clean state), but cannot confirm.

### ‚úÖ Changeset Added

**Evidence:** `.changeset/minimax-tts-integration.md` properly documents breaking changes, migration guide, and requirements.

### ‚úÖ Atomic Commits

**Commits:**
1. `edd51a4` - "feat(demo-toolkit): integrate MiniMax Speech API for TTS and voice cloning"
2. `855aba5` - "refactor(demo-toolkit): separate TTS and muxing modules for extractability"  
   **‚ö†Ô∏è This commit introduced the security vulnerability**
3. `99b0ab2` - "docs: update PR summary with architectural improvements"

**Good:** Each commit has a clear, focused purpose. Commit messages follow conventional format.

### ‚úÖ Bot Scripts Used

**Evidence:** PR author is `app/vertz-tech-lead` (GitHub App bot identity). Git commits show `kai@vertz.dev` as author, suggesting bot scripts were used correctly.

### ‚úÖ PR Approved

**Reviewer:** viniciusdacal  
**Status:** APPROVED (2026-02-14T17:12:03Z)  
**‚ö†Ô∏è Note:** Reviewer missed the security vulnerability

---

## ‚ö†Ô∏è Design Compliance: C (NO DESIGN DOC FOUND)

### ‚ùå No Design Document

**Issue:** No design doc found in `/workspace/vertz/plans/` or `/workspace/backstage/plans/`.

**Searched for:**
- MiniMax integration design
- TTS feature design
- Demo toolkit architecture (found `ARCHITECTURE.md` in PR, but no pre-implementation design)

**RULES.md requirement:**
> "Design doc in `vertz/plans/` ‚Äî needs josh (DX) + pm (product) + engineer approval"

**What exists instead:**
- Comprehensive `ARCHITECTURE.md` added *in the PR* (not pre-implementation)
- `PR_SUMMARY.md` with architectural rationale
- Detailed `TTS.md` API documentation

**Mitigation:** The architectural documentation is excellent, but it appears to be post-facto rather than pre-approved design.

### ‚úÖ Scope Adherence

**Good:** All changes are within demo-toolkit package. No scope creep detected.

**Files changed:**
- New: `src/tts.ts`, `src/muxing.ts`, `tests/tts.test.ts`, `tests/muxing.test.ts`
- New docs: `TTS.md`, `ARCHITECTURE.md`, `PR_SUMMARY.md`
- Updated: `src/index.ts`, `src/script-runner.ts`
- Changeset: `.changeset/minimax-tts-integration.md`

All changes logically belong to the TTS integration feature.

### ‚ö†Ô∏è Extraction Architecture

**Positive:** The modular architecture documented in `ARCHITECTURE.md` is well-thought-out:
- Self-contained modules (tts, muxing, recorder)
- Zero cross-module dependencies (except types.ts)
- Configuration via env vars or parameters
- Designed for future extraction into separate packages

However, this architectural decision should have been pre-approved in a design doc.

---

## ‚úÖ DX & Quality: B (EXCELLENT DOCUMENTATION, MISSING WALKTHROUGH)

### ‚úÖ Comprehensive Documentation

**Added files:**

1. **`TTS.md`** (361 lines) - Excellent API reference
   - Quick start examples
   - Complete API reference
   - Configuration guide
   - Error handling patterns
   - Troubleshooting guide
   - Migration guide from old shell-based TTS

2. **`ARCHITECTURE.md`** (384 lines) - Outstanding modular design documentation
   - Design philosophy
   - Module boundaries and rules
   - Extraction strategy
   - Testing strategy
   - Anti-patterns to avoid

3. **`PR_SUMMARY.md`** (206 lines) - Comprehensive PR context
   - Motivation and use cases
   - Technical details
   - Migration guide
   - Checklist

### ‚ö†Ô∏è Missing Developer Walkthrough

**RULES.md requirement:**
> "Every feature ticket MUST include a Developer Walkthrough section. The feature is NOT done until this walkthrough passes end-to-end."

**Issue:** No walkthrough demonstrating:
1. Fresh project setup
2. Following public docs to enable TTS
3. Verifying user-visible outcome
4. No undocumented steps

**Impact:** While documentation is excellent, we cannot verify the "5-minute rule" (can a developer go from zero to working in 5 minutes with just the docs?).

### ‚úÖ Examples Use Public API

**Good:** All examples in `TTS.md` use the exported public API:
```typescript
import { generateTTS, cloneVoice } from '@vertz/demo-toolkit';
```

No internal imports or undocumented steps required.

### ‚úÖ Type Safety

**Good:**
- Full TypeScript implementation
- `TTSOptions` interface for configuration
- Custom `MiniMaxTTSError` class with typed properties
- All functions properly typed

### ‚úÖ Error Handling

**Good:** Comprehensive error handling in `tts.ts`:
- API errors (401, 429, network failures)
- Retry logic with fallback endpoints
- Timeout handling
- Clear error messages with actionable information

---

## Violations Summary

| Rule | Severity | Description | Evidence |
|------|----------|-------------|----------|
| Zeroth Law: Security | **CRITICAL** | Shell command injection in `muxing.ts` | Lines 57-59, 105-110 use `execAsync` with template literals |
| Never commit without ticket | Major | No ticket found for feature | Searched `/workspace/vertz/tickets/` - none found |
| Design doc required | Major | No pre-implementation design | No design doc in `plans/` |
| Developer Walkthrough | Minor | No end-to-end walkthrough | Not in documentation |
| TDD compliance | Unknown | Cannot verify test-first approach | No session transcript found |

---

## Recommendations

### Immediate (Block Merge)

1. **üö® SECURITY FIX REQUIRED** - Replace `execAsync()` with `spawn()` in `muxing.ts`
   - Use argument arrays, never string interpolation
   - Validate all file paths before use
   - Add integration tests with malicious paths to prevent regression

2. **Create blocking follow-up ticket** for security fix
   - Ticket must be P0/critical priority
   - Must land before any other demo-toolkit work

### Short-term (Before Next PR)

3. **Preserve agent session logs**
   - Save session transcripts to `/workspace/agents/<agent>/memory/YYYY-MM-DD.md`
   - Include session metadata in PR descriptions
   - Enables audit verification of TDD compliance

4. **Create ticket for every feature**
   - Even small features need tickets
   - Ticket should reference design doc

5. **Pre-implementation design review**
   - Architectural changes (like modular extraction design) need pre-approval
   - Get josh (DX) + pm + tech lead sign-off before implementation

### Long-term (Process Improvement)

6. **Add security linting**
   - Detect `exec()` / `execAsync()` with template literals
   - Enforce `spawn()` usage in pre-commit hooks
   - Consider `eslint-plugin-security`

7. **Enhanced PR review checklist**
   - Include security review step
   - Check for shell command patterns
   - Verify ticket exists and design was approved

8. **Developer walkthrough requirement**
   - Add to definition of done
   - Must pass before PR approval
   - Document in PR description

---

## Positive Notes

Despite the critical security violation, several aspects of this PR demonstrate strong engineering:

1. **üìö Outstanding Documentation**
   - Three comprehensive documentation files (TTS.md, ARCHITECTURE.md, PR_SUMMARY.md)
   - Clear examples and migration guides
   - Well-structured API reference

2. **üèóÔ∏è Thoughtful Architecture**
   - Modular design enables future extraction
   - Clear module boundaries
   - Self-contained, testable components

3. **‚úÖ Good Test Coverage**
   - 23 tests covering major functionality
   - Proper mocking strategy
   - Both positive and negative test cases

4. **üîÑ Clean Commits**
   - Atomic, focused commits
   - Good commit messages
   - Logical progression

5. **üì¶ Proper Release Engineering**
   - Changeset includes breaking change documentation
   - Migration guide provided
   - Backward compatibility noted

**The engineering quality is high overall. The security violation appears to be an oversight rather than negligence.** However, Zeroth Law violations cannot be overlooked regardless of other quality metrics.

---

## Final Verdict

**Grade: F**

This PR must NOT merge as-is. The shell command injection vulnerability is a critical security flaw that violates the Zeroth Law (Security is non-negotiable). Per engineering rules, security violations are automatic failures regardless of other quality.

**Required action:** Security fix must land before merge. Once fixed, re-audit will likely result in B- or C+ grade (accounting for missing ticket and design doc, but recognizing strong implementation quality).

**Recommendation to CTO:** Block merge until security fix lands. Consider this a learning opportunity to strengthen security review process.

---

## Audit Metadata

**Auditor:** agent:auditor  
**Session:** agent:auditor:subagent:9cecb864-3eac-441b-bc5f-043c1a47b2ed  
**Audit Date:** 2026-02-14  
**Audit Duration:** ~30 minutes  
**PR Merged:** 2026-02-14T17:19:12Z (**‚ö†Ô∏è Already merged before audit**)  
**Remediation Required:** Yes - Immediate security fix needed  

**Note:** This PR was already merged before audit was conducted. Security fix must be applied retroactively as a high-priority follow-up PR.
