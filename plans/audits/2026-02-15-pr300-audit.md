# Post-Merge Audit: PR #300

**Title:** fix(task-manager): fix all 9 failing unit tests
**Author:** app/vertz-dev-dx | **Merged:** 2026-02-15T03:01:26Z
**Stats:** +50 / -11 across 6 files

## Grade: B+

## TDD Compliance

**Acceptable.** This is a test-fix PR — making existing failing tests pass. No new tests added, but existing tests are the specification. The fixes address environmental issues (happy-dom quirks) rather than production bugs.

## Test Coverage

- Fixes 3 test files: `router.test.ts`, `task-form.test.ts`, `task-list.test.ts`
- No coverage reduction — all existing tests preserved, just fixed.

## Code Quality

- **router.test.ts:** Clever `routerRef` pattern to avoid TDZ (temporal dead zone) issue where component closure referenced `router` before `createTestRouter` returned. Clean workaround with re-navigate to trigger re-render with ref set.
- **task-form.test.ts:** Directly sets `prioritySelect.value` and dispatches `submit` event on form instead of clicking button — works around happy-dom's incomplete form submission support. Pragmatic fix.
- **task-list.test.ts:** Moved assertions inside `waitFor()` — correct pattern for async rendering. Previous code had a race condition.
- **test-compiler-plugin.ts:** New Bun preload plugin that runs `@vertz/ui-compiler` transforms on `.tsx` files during test. Essential for test parity with Vite dev/build.
- **test-setup.ts:** Added `globalThis.FormData = window.FormData` — necessary for happy-dom environment.

## Security

- No security concerns. Test-only changes in example app.

## Potential Regressions

- `test-compiler-plugin.ts` filter regex (`/examples\/task-manager\/src\/.*\.tsx$/`) is scoped correctly — won't affect other packages.
- Direct form submission dispatch bypasses any button-level event listeners — acceptable for unit tests but note if button handlers are added later.
- `bunfig.toml` adds `root = "./src"` which changes test discovery root — verify all tests are still found.

## Notable Findings

Good diagnostic work identifying happy-dom limitations as the root cause. The compiler plugin addition is the most impactful change — without it, signal transforms weren't applied during tests, causing silent failures. This was likely the root cause for multiple test failures.
