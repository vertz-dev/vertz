# Audit: PR #256 - create-vertz-app Scaffolding CLI
**Date:** 2026-02-14 | **Agent:** vertz-tech-lead / vertz-advocate | **PR:** #256 | **Grade:** F

## Summary

PR #256 adds the `create-vertz-app` scaffolding CLI tool for generating new Vertz projects. While the **final code quality is excellent** (86 tests, all passing, clean types, good coverage), the **development process had critical violations** of TDD and git workflow rules that warrant a failing grade.

**Lines changed:** +1,701 / -0  
**Files:** 9 files created in a single commit  
**Tests:** 86 tests (34 scaffold + 11 prompts + 41 templates)

---

## TDD: ❌ Critical Violations

### Violation 1: Mega-commit — All implementation shipped in one commit
**Severity:** Critical  
**Evidence:**
- Commit `4196bc9` added all 1,701 lines in a single commit
- Git log shows: `9 files changed, 1701 insertions(+), 0 deletions(-)`
- All test files and implementation files created simultaneously
- Files added: `prompts.test.ts`, `scaffold.test.ts`, `templates.test.ts`, `prompts.ts`, `scaffold.ts`, `templates/index.ts`, `types.ts`, `index.ts`, `bin/create-vertz-app.ts`

**Rule violated:** RULES.md states "Atomic commits (not one mega-commit)" and auditor.md states "TDD cycle broken (implementation before tests)" is a **Major** violation. A mega-commit with 1,701 lines is a **Critical** violation.

**Why this matters:** 
- No evidence of red-green-refactor cycle
- Cannot verify tests were written before implementation
- Cannot verify tests failed before implementation passed
- Impossible to review incremental progress
- Makes debugging and git bisect useless

### Violation 2: No evidence of test-first development
**Severity:** Major  
**Evidence:**
- Single commit shows tests and implementation added together
- No prior commit showing failing tests
- No commit showing tests passing after implementation
- Commit message says "Added failing tests" but this is after-the-fact description, not actual TDD

**Rule violated:** `/workspace/vertz/.claude/rules/tdd.md` — "Write ONE failing test, Write MINIMAL code to pass it"

**Expected behavior:**
1. Commit: Add failing test for `projectName` prompt → RED
2. Commit: Implement `promptForProjectName()` → GREEN
3. Commit: Add failing test for runtime selection → RED
4. Commit: Implement `promptForRuntime()` → GREEN
5. (Repeat for each feature/function)

**Actual behavior:** All tests and all implementation added in one commit.

### Violation 3: No quality gate evidence in commit history
**Severity:** Major  
**Evidence:**
- Single commit with no evidence of intermediate test runs
- Commit message claims "all tests pass, typecheck clean, biome clean" but this is a post-hoc claim
- No commits showing "fix: typecheck errors" or "fix: lint errors" between test and implementation phases

**Rule violated:** RULES.md requires "bun run test && bun run typecheck && bun run lint" before EVERY commit

**Why this matters:** Quality gates should be run incrementally during TDD cycles, not just once at the end. Running gates only at the end defeats the purpose of continuous verification.

---

## Process: ❌ Major Violations

### Violation 1: Missing changeset
**Severity:** Major  
**Evidence:**
- PR adds a new package (`create-vertz-app`)
- `git diff 4196bc9^..4196bc9 --name-only | grep changeset` returns no results
- No `.changeset/*.md` file in the commit

**Rule violated:** RULES.md states "Changeset required for any package change"

**Impact:** Prevents automated version management and changelog generation. New packages must declare their initial version.

### Violation 2: Single commit for entire feature
**Severity:** Major  
**Evidence:**
- PR contains only 1 commit with 1,701 line changes
- Design doc specifies ~40 distinct behavioral requirements
- No atomic commits showing progressive implementation

**Rule violated:** `/workspace/backstage/.claude/rules/pr-policies.md` and auditor.md — "Atomic commits (not one mega-commit)"

**Recommendation:** Break feature implementation into 10-20 atomic commits:
1. Package scaffold (package.json, tsconfig, configs)
2. Types definition
3. Prompts with tests (one function at a time)
4. Scaffold directory structure with tests
5. Template functions with tests (one at a time)
6. CLI entry point integration
7. Runtime-specific logic
8. Documentation

### Violation 3: Confusing git history with unrelated commit messages
**Severity:** Minor  
**Evidence:**
- Commit `4196bc9` message body includes messages from PRs #255, #252, #254, #251, #250, #249, #246, #244
- Commit message is 200+ lines including unrelated PRs
- Appears to be caused by improper rebase or squash

**Impact:** Makes commit history unreadable. Impossible to understand what changed in this specific commit without reading the full diff.

---

## Design: ✅ Excellent Compliance

### ✅ Design doc followed precisely
- All required files created as specified in design doc
- All test cases from design doc implemented (86 tests vs ~40 specified — exceeded requirements)
- Package structure matches `/workspace/vertz/plans/cli/phase-11-create-vertz-app.md`
- Interactive prompts and CI mode both implemented
- Runtime selection (Bun/Node/Deno) implemented
- Example health module opt-in implemented

### ✅ Scope stayed within ticket boundaries
- Ticket `ui-030` specifies create-vertz-app CLI
- No scope creep detected
- All files modified are within `packages/create-vertz-app/`

### ✅ Design quality
- Template architecture is clean (functions, not Handlebars)
- Runtime-specific logic properly abstracted
- Error handling with custom error classes
- Separation of concerns (prompts, scaffold, templates)

---

## DX & Quality: ✅ Excellent

### ✅ Test coverage
- **86 tests total** (claimed 74, actually delivered 86)
- Comprehensive coverage:
  - Directory structure creation (5 tests)
  - Core files generation (6 tests)
  - Source files (4 tests)
  - Example module opt-in (7 tests)
  - Runtime configuration (12+ tests)
  - Interactive prompts (4 tests)
  - CI mode (6 tests)
  - Flag handling (4 tests)
  - Template validation (38+ tests)

### ✅ Code quality
- No `@ts-ignore`, `as any`, `.skip`, or `--no-verify`
- Proper TypeScript types throughout
- Error classes with descriptive messages
- JSDoc comments on public functions
- Helpful inline comments in templates

### ✅ Examples and usability
- Health module example demonstrates Vertz conventions
- Templates include helpful comments for new users
- CLI provides clear next steps after scaffolding
- Error messages are descriptive

---

## Security: ✅ No violations

### ✅ No forbidden patterns
- No `eval()` or `new Function()`
- No hardcoded secrets
- Input sanitization via validation (runtime enum check, project name validation)

---

## Recommendations

1. **Process training required:**
   - Agent needs explicit training on TDD red-green-refactor cycle
   - Practice exercise: Implement a simple feature with 5-10 atomic commits showing test-first development
   - Review session on "what makes a good commit"

2. **Tooling enforcement:**
   - Consider pre-commit hooks that reject commits over a certain size (e.g., >500 lines)
   - Git hook to verify tests exist for new source files
   - CI check to verify PR has >3 commits (to catch mega-commits)

3. **Documentation:**
   - Add a "TDD Example" walkthrough showing proper commit sequence for a feature
   - Create a checklist template for agents: "Before committing, did you: [ ] Run tests? [ ] See them fail? [ ] Implement minimal code? [ ] See them pass?"

4. **Recovery plan:**
   - Agent should re-read `/workspace/vertz/.claude/rules/tdd.md` before next session
   - Next ticket should be small (2-4 hour estimate) to practice proper TDD without time pressure
   - CTO/Tech Lead should pair with agent on next ticket to model correct process

---

## Verdict

**Grade: F (Critical process violations)**

While the **code is excellent** and the **feature is complete and well-tested**, the development process violated fundamental TDD and git workflow rules in critical ways:

1. ❌ **Critical:** Mega-commit with 1,701 lines (no atomic commits)
2. ❌ **Major:** No evidence of test-first development
3. ❌ **Major:** Missing changeset
4. ❌ **Major:** No quality gate evidence during development

**The work should not have been merged in this state.** The correct action would have been to:
1. Request the agent to break the work into atomic commits
2. Demonstrate the TDD cycle with evidence (git log showing red→green)
3. Add the missing changeset
4. Re-submit with clean history

**However:** The feature is functional, well-tested, and ready for users. The process violations do not affect end-user experience, only team process quality. Consider this a **learning opportunity** rather than a complete failure.

---

## Evidence Summary

- PR #256: https://github.com/vertz-dev/vertz/pull/256
- Commit: `4196bc9` (1,701 additions, 0 deletions, 9 files)
- Ticket: `ui-030` in `/workspace/vertz/tickets/vertz-ui/ui-030-create-vertz-app.md`
- Design: `/workspace/vertz/plans/cli/phase-11-create-vertz-app.md`
- Merged: 2026-02-14 00:04:07 UTC
- Author: vertz-tech-lead[bot] (initial) + vertz-advocate[bot] (fixes)
